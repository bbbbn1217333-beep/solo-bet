<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° ì‹œíŠ¸ì§€ ê´€ë¦¬ììš©</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@600;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    /* ê¸°ì¡´ UI ìŠ¤íƒ€ì¼ë¡œ ì™„ë²½ ë³µêµ¬ */
    body { margin:0; background:#111; color:#fff; font-family:'Pretendard',sans-serif; padding:20px; }
    .admin-header { background:#222; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #333; }
    .top-controls { display:flex; gap:15px; align-items:flex-end; margin-bottom:15px; }
    .header-group { display:flex; flex-direction:column; gap:5px; }
    .header-group label { font-size:12px; font-weight:800; color:#aaa; }
    .top-controls input { padding:8px 12px; background:#000; border:1px solid #444; border-radius:6px; color:#fff; font-size:14px; outline:none; }
    #teamCount { width:60px; text-align:center; }
    .btn-load-data { padding:8px 15px; background:#333; color:#fff; border:1px solid #444; border-radius:6px; cursor:pointer; font-size:13px; font-weight:800; }
    .btn-load-data:hover { background:#444; }

    .teams-container { display:flex; gap:20px; }
    .team-box { flex:1; background:#1a1a1a; padding:15px; border-radius:12px; border-top:4px solid; }
    .team-box.red { border-color:#ff5c5c; }
    .team-box.blue { border-color:#4db8ff; }
    .team-box h2 { font-family:'Orbitron'; font-size:22px; margin-top:0; margin-bottom:15px; }

    .member-list { display:flex; flex-direction:column; gap:15px; }
    .member-card { background:#252525; padding:15px; border-radius:10px; border:1px solid #333; }
    
    /* ì…ë ¥ì°½ í¬ê¸°(ë„¤ëª¨ì¹¸) ê¸°ì¡´ ì‚¬ì´ì¦ˆë¡œ ë³µêµ¬ */
    .name-row { display:flex; gap:8px; margin-bottom:12px; align-items:flex-end; }
    .input-group { display:flex; flex-direction:column; gap:4px; }
    .input-group label { font-size:11px; color:#888; }
    .nick-disp { width:100px; padding:6px; background:#000; border:1px solid #444; border-radius:4px; color:#fff; font-size:13px; }
    .nick-riot { width:150px; padding:6px; background:#000; border:1px solid #444; border-radius:4px; color:#fff; font-size:13px; }
    .tier-select { padding:5px; background:#000; border:1px solid #444; border-radius:4px; color:#fff; font-size:12px; width:120px; }
    .lp-input { width:45px; padding:6px; background:#000; border:1px solid #444; border-radius:4px; color:#fff; text-align:center; font-size:13px; }
    .score-input { width:35px; padding:6px; background:#000; border:1px solid #444; border-radius:4px; color:#fff; text-align:center; font-size:13px; }

    .history-editor { display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; background:#111; padding:10px; border-radius:8px; }
    .history-item { display:flex; flex-direction:column; gap:4px; align-items:center; }
    .history-item span { font-size:10px; color:#666; }
    .champ-input { width:90%; background:#000; border:1px solid #333; color:#fff; text-align:center; padding:4px; border-radius:4px; font-size:11px; }
    .btn-toggle { width:100%; padding:4px 0; font-size:10px; font-weight:800; border:none; border-radius:3px; cursor:pointer; }
    .btn-toggle.win { background:#ffd369; color:#000; }
    .btn-toggle.lose { background:#ff6b6b; color:#fff; }
    .btn-toggle.ing { background:#444; color:#aaa; }

    .btn-apply { position:fixed; bottom:30px; right:30px; padding:15px 40px; font-size:18px; font-weight:800; background:#ff5c5c; color:#fff; border:none; border-radius:10px; cursor:pointer; box-shadow:0 4px 15px rgba(255,92,92,0.4); }
    .btn-apply:hover { transform:scale(1.05); }
</style>
</head>
<body>

<div class="admin-header">
    <div class="top-controls">
        <div class="header-group"><label>ë ˆë“œ íŒ€ ëª…ì¹­</label><input id="redNameInput" oninput="updateTeamNames()"></div>
        <div class="header-group"><label>ë¸”ë£¨ íŒ€ ëª…ì¹­</label><input id="blueNameInput" oninput="updateTeamNames()"></div>
        <div class="header-group"><label>ì¢…ë£Œ ì‹œê°„</label><input id="endDateTime" type="datetime-local"></div>
        <div class="header-group"><label>ì¸ì›</label><input id="teamCount" type="number" value="5" onchange="rebuildWithCache()"></div>
        <button class="btn-load-data" onclick="loadData()">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
</div>

<div class="teams-container">
    <div class="team-box red"><h2 id="redTitle">RED TEAM</h2><div id="redPlayers" class="member-list"></div></div>
    <div class="team-box blue"><h2 id="blueTitle">BLUE TEAM</h2><div id="bluePlayers" class="member-list"></div></div>
</div>

<button class="btn-apply" onclick="applyToSupabase()">ì†¡ì¶œ í™”ë©´ ë°˜ì˜</button>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = { "CHALLENGER": "ì±Œë¦°ì €", "GRANDMASTER": "ê·¸ëœë“œë§ˆìŠ¤í„°", "MASTER": "ë§ˆìŠ¤í„°", "DIAMOND 1": "ë‹¤ì´ì•„ëª¬ë“œ 1", "DIAMOND 2": "ë‹¤ì´ì•„ëª¬ë“œ 2", "DIAMOND 3": "ë‹¤ì´ì•„ëª¬ë“œ 3", "DIAMOND 4": "ë‹¤ì´ì•„ëª¬ë“œ 4", "EMERALD 1": "ì—ë©”ë„ë“œ 1", "EMERALD 2": "ì—ë©”ë„ë“œ 2", "EMERALD 3": "ì—ë©”ë„ë“œ 3", "EMERALD 4": "ì—ë©”ë„ë“œ 4", "PLATINUM 1": "í”Œë˜í‹°ë„˜ 1", "PLATINUM 2": "í”Œë˜í‹°ë„˜ 2", "PLATINUM 3": "í”Œë˜í‹°ë„˜ 3", "PLATINUM 4": "í”Œë˜í‹°ë„˜ 4", "GOLD 1": "ê³¨ë“œ 1", "GOLD 2": "ê³¨ë“œ 2", "GOLD 3": "ê³¨ë“œ 3", "GOLD 4": "ê³¨ë“œ 4", "SILVER 1": "ì‹¤ë²„ 1", "SILVER 2": "ì‹¤ë²„ 2", "SILVER 3": "ì‹¤ë²„ 3", "SILVER 4": "ì‹¤ë²„ 4", "BRONZE 1": "ë¸Œë¡ ì¦ˆ 1", "BRONZE 2": "ë¸Œë¡ ì¦ˆ 2", "BRONZE 3": "ë¸Œë¡ ì¦ˆ 3", "BRONZE 4": "ë¸Œë¡ ì¦ˆ 4", "IRON 1": "ì•„ì´ì–¸ 1", "IRON 2": "ì•„ì´ì–¸ 2", "IRON 3": "ì•„ì´ì–¸ 3", "IRON 4": "ì•„ì´ì–¸ 4", "UNRANKED": "ì–¸ë­í¬" };
const TIER_RANK = { "ì±Œë¦°ì €":30, "ê·¸ëœë“œë§ˆìŠ¤í„°":29, "ë§ˆìŠ¤í„°":28, "ë‹¤ì´ì•„ëª¬ë“œ 1":27, "ë‹¤ì´ì•„ëª¬ë“œ 2":26, "ë‹¤ì´ì•„ëª¬ë“œ 3":25, "ë‹¤ì´ì•„ëª¬ë“œ 4":24, "ì—ë©”ë„ë“œ 1":23, "ì—ë©”ë„ë“œ 2":22, "ì—ë©”ë„ë“œ 3":21, "ì—ë©”ë„ë“œ 4":20, "í”Œë˜í‹°ë„˜ 1":19, "í”Œë˜í‹°ë„˜ 2":18, "í”Œë˜í‹°ë„˜ 3":17, "í”Œë˜í‹°ë„˜ 4":16, "ê³¨ë“œ 1":15, "ê³¨ë“œ 2":14, "ê³¨ë“œ 3":13, "ê³¨ë“œ 4":12, "ì‹¤ë²„ 1":11, "ì‹¤ë²„ 2":10, "ì‹¤ë²„ 3":9, "ì‹¤ë²„ 4":8, "ë¸Œë¡ ì¦ˆ 1":7, "ë¸Œë¡ ì¦ˆ 2":6, "ë¸Œë¡ ì¦ˆ 3":5, "ë¸Œë¡ ì¦ˆ 4":4, "ì•„ì´ì–¸ 1":3, "ì•„ì´ì–¸ 2":2, "ì•„ì´ì–¸ 3":1, "ì•„ì´ì–¸ 4":0, "ì–¸ë­í¬": -1 };

let cachedPlayers = [];

function updateTeamNames() {
    document.getElementById('redTitle').innerText = document.getElementById('redNameInput').value || 'RED TEAM';
    document.getElementById('blueTitle').innerText = document.getElementById('blueNameInput').value || 'BLUE TEAM';
}

function toggleResult(btn) {
    if (btn.innerText.includes('ìŠ¹ë¦¬')) { btn.innerText = 'íŒ¨ë°°'; btn.className = 'btn-toggle lose'; }
    else if (btn.innerText.includes('íŒ¨ë°°')) { btn.innerText = 'ì§„í–‰'; btn.className = 'btn-toggle ing'; }
    else { btn.innerText = 'ìŠ¹ë¦¬'; btn.className = 'btn-toggle win'; }
}

function createMemberCard(team, data = null) {
    const card = document.createElement('div');
    card.className = 'member-card'; card.dataset.team = team; card.dataset.id = data?.id || "";
    
    let historyHTML = '';
    for(let i=0; i<10; i++) {
        const champ = data?.champions?.[i] || '';
        const res = data?.recent?.[i] || 'ing';
        const resText = res === 'win' ? 'ìŠ¹ë¦¬' : (res === 'lose' ? 'íŒ¨ë°°' : 'ì§„í–‰');
        historyHTML += `<div class="history-item"><span>${i+1}</span><input type="text" class="champ-input" value="${champ}"><button class="btn-toggle ${res}" onclick="toggleResult(this)">${resText}</button></div>`;
    }

    let currentTierEng = "UNRANKED", currentLP = "";
    if (data?.tier && data.tier !== "ì–¸ë­í¬") {
        const tierPart = data.tier.split(' - ')[0];
        currentTierEng = Object.keys(TIER_MAP).find(key => TIER_MAP[key] === tierPart) || "UNRANKED";
        currentLP = data.tier.match(/(\d+)LP/)?.[1] || "";
    }

    const tierOptions = Object.entries(TIER_MAP).map(([eng, kor]) => `<option value="${eng}" ${currentTierEng === eng ? 'selected' : ''}>${kor}</option>`).join('');

    card.innerHTML = `
        <div class="name-row">
            <div class="input-group"><label>ìŠ¤íŠ¸ë¦¬ë¨¸</label><input class="nick-disp" value="${data?.name || ''}"></div>
            <div class="input-group"><label>ë¡¤ ë‹‰ë„¤ì„</label><input class="nick-riot" value="${data?.riot_id || ''}"></div>
            <div class="input-group"><label>í‹°ì–´</label><select class="tier-select">${tierOptions}</select></div>
            <div class="input-group"><label>LP</label><input class="lp-input" value="${currentLP}"></div>
            <div class="input-group"><label>ìŠ¹</label><input class="score-input" value="${data?.wins ?? ''}"></div>
            <div class="input-group"><label>íŒ¨</label><input class="score-input" value="${data?.losses ?? ''}"></div>
        </div>
        <div class="history-editor">${historyHTML}</div>`;
    return card;
}

function rebuildWithCache() { rebuild(cachedPlayers); }
function rebuild(dataList) {
    const redWrap = document.getElementById('redPlayers'); const blueWrap = document.getElementById('bluePlayers');
    const count = Number(document.getElementById('teamCount').value);
    redWrap.innerHTML = ''; blueWrap.innerHTML = '';
    const reds = dataList.filter(p => p.team === 'red');
    const blues = dataList.filter(p => p.team === 'blue');
    for(let i=0; i<count; i++) {
        redWrap.appendChild(createMemberCard('red', reds[i]));
        blueWrap.appendChild(createMemberCard('blue', blues[i]));
    }
}

async function loadData() {
    const { data: sData } = await sb.from('settings').select('*').eq('id', 1).single();
    if (sData) {
        document.getElementById('redNameInput').value = sData.red_team_name;
        document.getElementById('blueNameInput').value = sData.blue_team_name;
        document.getElementById('teamCount').value = sData.member_count;
        if(sData.timer_end_at) document.getElementById('endDateTime').value = sData.timer_end_at.slice(0,16);
        updateTeamNames();
    }
    const { data: pData } = await sb.from('players').select('*').order('created_at', { ascending: true });
    cachedPlayers = pData || [];
    rebuild(cachedPlayers);
}

async function applyToSupabase() {
    const cards = document.querySelectorAll('.member-card');
    const playersToUpdate = [];
    let cutsceneFound = false;

    for (const card of cards) {
        const name = card.querySelector('.nick-disp').value.trim();
        if (!name) continue;

        const existing = cachedPlayers.find(p => p.id == card.dataset.id);
        const recent = [], champs = [];
        card.querySelectorAll('.history-item').forEach(item => {
            const btnText = item.querySelector('.btn-toggle').innerText;
            recent.push(btnText === 'ìŠ¹ë¦¬' ? 'win' : (btnText === 'íŒ¨ë°°' ? 'lose' : 'ing'));
            champs.push(item.querySelector('.champ-input').value.trim() || 'None');
        });

        const tEng = card.querySelector('.tier-select').value;
        const lpVal = card.querySelector('.lp-input').value.trim();
        const currentTierStr = (lpVal && tEng !== "UNRANKED") ? `${TIER_MAP[tEng]} - ${lpVal}LP` : TIER_MAP[tEng];

        let trigger = false, eventType = null, lpDiff = "", targetChamp = "None";
        const lastResIdx = recent.findLastIndex(r => r === 'win' || r === 'lose');

        // ì»·ì”¬ ë¡œì§ (í•œ ë²ˆì— í•œ ëª…ë§Œ ë°œìƒí•˜ë„ë¡ ì„¤ì •)
        if (!cutsceneFound && lastResIdx !== -1) {
            trigger = true; cutsceneFound = true;
            targetChamp = champs[lastResIdx];
            if (existing) {
                const oldLP = parseInt(existing.tier.match(/(\d+)LP/)?.[1] || 0);
                const newLP = parseInt(lpVal || 0);
                const diff = newLP - oldLP;
                lpDiff = diff >= 0 ? `+${diff}LP` : `${diff}LP`;

                const oldRank = TIER_RANK[existing.tier.split(' - ')[0]] || -1;
                const newRank = TIER_RANK[TIER_MAP[tEng]] || -1;

                if (recent[lastResIdx] === 'win') {
                    if (Math.floor(newRank/4) > Math.floor(oldRank/4)) eventType = 'promotion_major';
                    else if (newRank > oldRank) eventType = 'promotion';
                    else eventType = 'victory';
                } else {
                    if (newRank < oldRank) eventType = 'demotion';
                    else eventType = 'defeat';
                }
            }
        }

        playersToUpdate.push({
            id: card.dataset.id || undefined,
            name, team: card.dataset.team, riot_id: card.querySelector('.nick-riot').value,
            tier: currentTierStr, wins: Number(card.querySelector('.score-input:nth-child(5) input').value) || recent.filter(r=>r==='win').length,
            losses: Number(card.querySelector('.score-input:nth-child(6) input').value) || recent.filter(r=>r==='lose').length,
            recent, champions: champs, trigger_cutscene: trigger, event_type: eventType, lp_diff: lpDiff, target_champion: targetChamp
        });
    }

    await sb.from('settings').upsert({ id: 1, red_team_name: document.getElementById('redNameInput').value, blue_team_name: document.getElementById('blueNameInput').value, member_count: Number(document.getElementById('teamCount').value), timer_end_at: document.getElementById('endDateTime').value });
    await sb.from('players').upsert(playersToUpdate);
    alert('ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
    loadData();
}

loadData();
</script>
</body>
</html>




















