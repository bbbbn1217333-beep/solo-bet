<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° ì‹œíŠ¸ì§€ ê´€ë¦¬ììš©</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@600;800;900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #ff3b3b; --blue: #4db8ff; --gold: #ffd369; --emerald: #2ecc71; --neon-red: 0 0 15px rgba(255, 59, 59, 0.8); --neon-blue: 0 0 15px rgba(77, 184, 255, 0.8); --neon-gold: 0 0 20px rgba(255, 211, 105, 0.8); }
        body { margin:0; background:#0e0e0e; color:#fff; font-family:'Pretendard',sans-serif; padding:15px; padding-bottom: 120px; overflow-x: auto; }
        .wrap { width: 1550px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .admin-header { background:#1a1a1a; padding:25px; border-radius:15px; border: 2px solid var(--gold); box-shadow: var(--neon-gold); }
        .top-controls { display:flex; gap:20px; align-items:flex-end; margin-bottom:20px; flex-wrap: nowrap; }
        .header-group { display:flex; flex-direction:column; gap:8px; }
        .label-gold { font-size:15px; font-weight:900; color:var(--gold); text-shadow: 0 0 8px rgba(255,211,105,0.5); }
        .top-controls input, .timer-input-wrap, .btn-load-data { height: 50px !important; box-sizing: border-box; }
        .top-controls input { padding:12px; background:#000; border-radius:8px; font-size:16px; font-weight:900; outline:none; border: 2px solid var(--gold); color: #fff; box-shadow: var(--neon-gold); }
        .timer-input-wrap { display: flex; align-items: center; background: #000; padding: 0 15px; border-radius: 8px; border: 2px solid var(--gold); box-shadow: var(--neon-gold); width: 320px; }
        #endDateTime { background: transparent; border: none; color: #fff; font-family: 'Pretendard'; font-weight: 900; font-size: 16px; outline: none; color-scheme: dark; width: 100%; box-shadow: none !important; }
        .btn-load-data { padding:0 25px; background:#000; color:var(--emerald); border:2px solid var(--emerald); border-radius:8px; cursor:pointer; font-weight:900; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); font-size: 15px; display: flex; align-items: center; justify-content: center; }
        .menu-desc { font-size:14px; color:#ccc; line-height:1.8; background:#111; padding:22px; border-radius:10px; border: 2px solid var(--gold); margin-top: 10px; font-weight: 800; }
        .teams-container { display:flex; gap:25px; width: 100%; }
        .team-box { flex:1; background:#1a1a1a; padding:20px; border-radius:15px; border-top: 5px solid; min-width: 740px; }
        .team-box.red { border-color: var(--red); }
        .team-box.blue { border-color: var(--blue); }
        .member-list { display:flex; flex-direction:column; gap:20px; max-height:850px; overflow-y:auto; padding: 10px; }
        .member-card { background:#151515; border-radius:12px; padding:20px; border: 2px solid; margin-bottom: 5px; }
        .red .member-card { border-color: var(--red); }
        .blue .member-card { border-color: var(--blue); }
        .name-row { display:flex; gap:8px; margin-bottom:15px; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; align-items: center; }
        .input-group label { font-size:12px; font-weight:900; color:#fff; margin-bottom: 6px; }
        .tier-select { height: 44px; width: 100%; padding: 0 10px; background:#000; border: 2px solid var(--gold) !important; border-radius:6px; font-size:14px; font-weight: 900; color: var(--gold); outline:none; text-align: center; }
        
        /* í‹°ì–´ë³„ ìƒ‰ìƒ ê°•ì œ ì§€ì • */
        .tier-select[data-tier*="ì±Œë¦°ì €"] { color: #ff4e50 !important; border-color: #ff4e50 !important; }
        .tier-select[data-tier*="ê·¸ëœë“œë§ˆìŠ¤í„°"] { color: #ff7f7f !important; border-color: #ff7f7f !important; }
        .tier-select[data-tier*="ë§ˆìŠ¤í„°"] { color: #e3a3ff !important; border-color: #e3a3ff !important; }
        .tier-select[data-tier*="ë‹¤ì´ì•„"] { color: #57bbff !important; border-color: #57bbff !important; }
        .tier-select[data-tier*="ì—ë©”ë„ë“œ"] { color: #2ecc71 !important; border-color: #2ecc71 !important; }
        .tier-select[data-tier*="í”Œë˜í‹°ë„˜"] { color: #4ecdc4 !important; border-color: #4ecdc4 !important; }
        .tier-select[data-tier*="ê³¨ë“œ"] { color: #f1c40f !important; border-color: #f1c40f !important; }
        .tier-select[data-tier*="ì‹¤ë²„"] { color: #bdc3c7 !important; border-color: #bdc3c7 !important; }
        .tier-select[data-tier*="ë¸Œë¡ ì¦ˆ"] { color: #a67c52 !important; border-color: #a67c52 !important; }
        .tier-select[data-tier*="ì•„ì´ì–¸"] { color: #7f8c8d !important; border-color: #7f8c8d !important; }

        .nick-disp, .nick-riot, .lp-input, .score-input { height: 44px; background:#000; border-radius:6px; color: #fff; text-align: center; font-weight: 900; border: 2px solid; outline:none; }
        .lp-input { border-color: var(--gold) !important; color: var(--gold); }
        .history-editor { display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; background:#0c0c0c; padding:15px; border-radius:10px; }
        .history-item { display:flex; flex-direction:column; gap:6px; align-items:center; padding: 10px 5px; border-radius: 8px; border: 2px solid; }
        .history-item span { color: var(--gold); font-weight: 900; font-size: 12px; }
        .btn-toggle { width:100%; padding:8px 0; font-size:11px; font-weight:900; border:none; border-radius:4px; cursor:pointer; }
        .btn-toggle.win { background: var(--gold); color: #000; }
        .btn-toggle.lose { background: var(--red); color: #fff; }
        .btn-toggle.ing { background: var(--emerald); color: #fff; }
        .btn-apply { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 70px; font-size:24px; font-weight:900; background: var(--red); color:#fff; border:none; border-radius:15px; cursor:pointer; box-shadow: 0 0 30px rgba(255, 59, 59, 0.7); }
    </style>
</head>
<body>

<div class="wrap">
    <div class="admin-header">
        <div class="top-controls">
            <div class="header-group"><label class="label-gold">ğŸš© ë ˆë“œ íŒ€</label><input id="redNameInput" oninput="updateTeamNames()"></div>
            <div class="header-group"><label class="label-gold">ğŸš© ë¸”ë£¨ íŒ€</label><input id="blueNameInput" oninput="updateTeamNames()"></div>
            <div class="header-group"><label class="label-gold">â° ì¢…ë£Œ ì‹œê°„</label><div class="timer-input-wrap"><input id="endDateTime" type="datetime-local"></div></div>
            <div class="header-group"><label class="label-gold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì¸ì›</label><input id="teamCount" type="number" min="1" max="33" value="5" onchange="rebuildWithCache()"></div>
            <button id="watchBtn" class="btn-load-data" onclick="toggleWatch()">â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘</button>
            <button class="btn-load-data" onclick="loadData()">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
    </div>

    <div class="teams-container">
        <div class="team-box red"><h2 id="redTitle">ë ˆë“œ íŒ€</h2><div id="redPlayers" class="member-list"></div></div>
        <div class="team-box blue"><h2 id="blueTitle">ë¸”ë£¨ íŒ€</h2><div id="bluePlayers" class="member-list"></div></div>
    </div>
</div>

<button class="btn-apply" onclick="applyToSupabase()">ì†¡ì¶œ í™”ë©´ ë°˜ì˜</button>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = { "CHALLENGER": "ì±Œë¦°ì €", "GRANDMASTER": "ê·¸ëœë“œë§ˆìŠ¤í„°", "MASTER": "ë§ˆìŠ¤í„°", "DIAMOND 1": "ë‹¤ì´ì•„ëª¬ë“œ 1", "DIAMOND 2": "ë‹¤ì´ì•„ëª¬ë“œ 2", "DIAMOND 3": "ë‹¤ì´ì•„ëª¬ë“œ 3", "DIAMOND 4": "ë‹¤ì´ì•„ëª¬ë“œ 4", "EMERALD 1": "ì—ë©”ë„ë“œ 1", "EMERALD 2": "ì—ë©”ë„ë“œ 2", "EMERALD 3": "ì—ë©”ë„ë“œ 3", "EMERALD 4": "ì—ë©”ë„ë“œ 4", "PLATINUM 1": "í”Œë˜í‹°ë„˜ 1", "PLATINUM 2": "í”Œë˜í‹°ë„˜ 2", "PLATINUM 3": "í”Œë˜í‹°ë„˜ 3", "PLATINUM 4": "í”Œë˜í‹°ë„˜ 4", "GOLD 1": "ê³¨ë“œ 1", "GOLD 2": "ê³¨ë“œ 2", "GOLD 3": "ê³¨ë“œ 3", "GOLD 4": "ê³¨ë“œ 4", "SILVER 1": "ì‹¤ë²„ 1", "SILVER 2": "ì‹¤ë²„ 2", "SILVER 3": "ì‹¤ë²„ 3", "SILVER 4": "ì‹¤ë²„ 4", "BRONZE 1": "ë¸Œë¡ ì¦ˆ 1", "BRONZE 2": "ë¸Œë¡ ì¦ˆ 2", "BRONZE 3": "ë¸Œë¡ ì¦ˆ 3", "BRONZE 4": "ë¸Œë¡ ì¦ˆ 4", "IRON 1": "ì•„ì´ì–¸ 1", "IRON 2": "ì•„ì´ì–¸ 2", "IRON 3": "ì•„ì´ì–¸ 3", "IRON 4": "ì•„ì´ì–¸ 4", "UNRANKED": "ì–¸ë­í¬" };

let cachedPlayers = [];
let autoSyncInterval = null; 
let idToNameMap = {}; 
let watchStartTime = null; 

async function initChampMap() {
    try {
        const res = await fetch(`https://ddragon.leagueoflegends.com/cdn/16.3.1/data/ko_KR/champion.json`);
        const json = await res.json();
        Object.values(json.data).forEach(c => { idToNameMap[c.key] = c.name; });
    } catch (e) { console.error(e); }
}

async function toggleWatch() {
    const btn = document.getElementById('watchBtn');
    if (autoSyncInterval) {
        clearInterval(autoSyncInterval); autoSyncInterval = null;
        btn.innerText = "â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘";
    } else {
        watchStartTime = Date.now(); 
        btn.innerText = "â¹ï¸ ê°ì‹œ ì¤‘ (45ì´ˆ ì£¼ê¸°)";
        await syncWithRiot();
        autoSyncInterval = setInterval(syncWithRiot, 45000); 
    }
}

async function syncWithRiot() { 
    try { 
        const syncUrl = watchStartTime ? `/api/sync?startTime=${watchStartTime}` : `/api/sync`;
        await fetch(syncUrl); 
        const { data: pData } = await sb.from('players').select('*').order('created_at', { ascending: true });
        if (pData) { mergeRebuild(pData); }
    } catch (e) { console.error(e); } 
}

// í‹°ì–´ ë§¤ì¹­ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜ (ìœ ì—°í•œ ë¹„êµ ë³´ê°•)
function findEngTierKey(tierStr) {
    if (!tierStr || tierStr === "ì–¸ë­í¬") return "UNRANKED";
    
    // 1. ì…ë ¥ì„ ëŒ€ë¬¸ìë¡œ ë°”ê¾¸ê³  ëª¨ë“  ê³µë°± ì œê±° (ì˜ˆ: "Platinum 1" -> "PLATINUM1")
    const cleanInput = tierStr.toUpperCase().replace(/\s+/g, '');
    
    // 2. TIER_MAPì„ ëŒë©° ë§¤ì¹­ í™•ì¸
    for (const [eng, kor] of Object.entries(TIER_MAP)) {
        const cleanEng = eng.replace(/\s+/g, ''); // "PLATINUM 1" -> "PLATINUM1"
        const cleanKor = kor.replace(/\s+/g, ''); // "í”Œë˜í‹°ë„˜ 1" -> "í”Œë˜í‹°ë„˜1"
        
        // ì˜ë¬¸ í‚¤ë‚˜ í•œê¸€ ëª…ì¹­ì´ ì…ë ¥ê°’ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (cleanInput.includes(cleanEng) || 
            cleanInput.includes(cleanKor) || 
            cleanEng.includes(cleanInput) || 
            cleanKor.includes(cleanInput)) {
            return eng;
        }
    }

    // 3. ì˜ˆì™¸ ì¼€ì´ìŠ¤: "í”Œë ˆ"ë¼ê³  ì…ë ¥ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ í”Œë˜í‹°ë„˜ ì „ìš© ë³´ì •
    if (cleanInput.includes("í”Œë˜") || cleanInput.includes("í”Œë ˆ") || cleanInput.includes("PLAT")) {
        // ë‹¨ê³„ë¥¼ ì°¾ìŒ (1, 2, 3, 4)
        const level = tierStr.match(/[1-4]/);
        return level ? `PLATINUM ${level[0]}` : "PLATINUM 4";
    }

    return "UNRANKED";
}

function mergeRebuild(dbData) {
    cachedPlayers = dbData;
    const cards = document.querySelectorAll('.member-card');
    
    cards.forEach(card => {
        const uuid = card.dataset.uuid;
        const dbPlayer = dbData.find(p => p.id === uuid);
        if (!dbPlayer) return;

        const tSelect = card.querySelector('.tier-select');
        const lInput = card.querySelector('.lp-input');
        const tCheck = card.querySelector('.tier-override');

        // ìë™ ë™ê¸°í™” ëª¨ë“œ(ìˆ˜ì • ì²´í¬ í•´ì œ)ì¼ ë•Œë§Œ í™”ë©´ ê°±ì‹ 
        if (!tCheck.checked) {
            const engKey = findEngTierKey(dbPlayer.tier);
            tSelect.value = engKey;
            tSelect.setAttribute('data-tier', TIER_MAP[engKey]);
            lInput.value = dbPlayer.tier?.match(/(\d+)LP/)?.[1] || "0";
        }

        // ì „ì  ì—…ë°ì´íŠ¸
        const items = card.querySelectorAll('.history-item');
        items.forEach((item, idx) => {
            const btn = item.querySelector('.btn-toggle');
            const champInp = item.querySelector('.champ-input');
            const dbRes = dbPlayer.recent?.[idx];
            const dbChamp = dbPlayer.champions?.[idx];

            if (btn.classList.contains('ing')) {
                if (dbRes === 'win') { btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; btn.className = 'btn-toggle win'; }
                else if (dbRes === 'lose' || dbRes === 'leaver_loss') { btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; btn.className = 'btn-toggle lose'; }
                if (dbChamp && dbChamp !== 'None') { champInp.value = idToNameMap[dbChamp] || dbChamp; }
            }
        });
    });
}

function createMemberCard(team, data = null) {
    const card = document.createElement('div');
    card.className = 'member-card'; card.dataset.team = team; card.dataset.uuid = data?.id || ""; 
    
    let historyHTML = '';
    for(let i=0; i<10; i++) {
        const res = data?.recent?.[i] || 'ing';
        const resText = res === 'win' ? 'ğŸ˜ ìŠ¹ë¦¬' : (res === 'lose' ? 'ğŸ˜¡ íŒ¨ë°°' : 'ğŸ•’ ì§„í–‰');
        let champDisp = (data?.champions?.[i] && data?.champions?.[i] !== 'None') ? (idToNameMap[data.champions[i]] || data.champions[i]) : '';
        historyHTML += `<div class="history-item"><span>${i+1}íŒ</span><input type="text" class="champ-input" value="${champDisp}"><button class="btn-toggle ${res==='win'?'win':res==='lose'?'lose':'ing'}" onclick="toggleResult(this)">${resText}</button></div>`;
    }
    
    const curTierEng = findEngTierKey(data?.tier);
    const curLP = data?.tier?.match(/(\d+)LP/)?.[1] || "";
    const tierOptions = Object.entries(TIER_MAP).map(([eng, kor]) => `<option value="${eng}" ${curTierEng === eng ? 'selected' : ''}>${kor}</option>`).join('');
    
    card.innerHTML = `
        <div class="name-row">
            <div class="input-group"><label>ìŠ¤íŠ¸ë¦¬ë¨¸</label><input class="nick-disp" value="${data?.name || ''}"></div>
            <div class="input-group" style="flex:2;"><label>ë¡¤ ë‹‰ë„¤ì„</label><input class="nick-riot" value="${data?.riot_id || ''}"></div>
            <div class="input-group" style="flex:1.8;"><label><input type="checkbox" class="tier-override" ${data?.manual_tier ? 'checked' : ''}> ìˆ˜ì •</label><select class="tier-select" ${data?.manual_tier ? '' : 'disabled'}>${tierOptions}</select></div>
            <div class="input-group" style="width:75px;"><label>LP</label><input class="lp-input" value="${curLP}" ${data?.manual_tier ? '' : 'disabled'}></div>
            <div class="input-group" style="width:50px;"><label>ìŠ¹</label><input class="score-input win-val" value="${data?.wins ?? 0}"></div>
            <div class="input-group" style="width:50px;"><label>íŒ¨</label><input class="score-input lose-val" value="${data?.losses ?? 0}"></div>
        </div>
        <div class="history-editor">${historyHTML}</div>`;
    
    const tSelect = card.querySelector('.tier-select');
    tSelect.setAttribute('data-tier', TIER_MAP[curTierEng]);
    tSelect.addEventListener('change', () => tSelect.setAttribute('data-tier', tSelect.options[tSelect.selectedIndex].text));
    
    const tCheck = card.querySelector('.tier-override');
    tCheck.addEventListener('change', () => {
        tSelect.disabled = !tCheck.checked;
        card.querySelector('.lp-input').disabled = !tCheck.checked;
    });
    return card;
}

// ë‚˜ë¨¸ì§€ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
function updateTeamNames() {
    document.getElementById('redTitle').innerText = document.getElementById('redNameInput').value || 'ë ˆë“œ íŒ€';
    document.getElementById('blueTitle').innerText = document.getElementById('blueNameInput').value || 'ë¸”ë£¨ íŒ€';
}
function toggleResult(btn) {
    if (btn.innerText.includes('ìŠ¹ë¦¬')) { btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; btn.className = 'btn-toggle lose'; }
    else if (btn.innerText.includes('íŒ¨ë°°')) { btn.innerText = 'ğŸ•’ ì§„í–‰'; btn.className = 'btn-toggle ing'; }
    else { btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; btn.className = 'btn-toggle win'; }
}
function rebuildWithCache() { rebuild(cachedPlayers); }
function rebuild(dataList = null) {
    const redWrap = document.getElementById('redPlayers'); const blueWrap = document.getElementById('bluePlayers'); const count = Number(document.getElementById('teamCount').value);
    redWrap.innerHTML = ''; blueWrap.innerHTML = '';
    const reds = dataList?.filter(p => p.team === 'red') || [];
    const blues = dataList?.filter(p => p.team === 'blue') || [];
    for(let i=0; i<count; i++) { redWrap.appendChild(createMemberCard('red', reds[i])); blueWrap.appendChild(createMemberCard('blue', blues[i])); }
}
async function loadData() {
    const { data: sData } = await sb.from('settings').select('*').eq('id', 1).single();
    if (sData) { 
        document.getElementById('redNameInput').value = sData.red_team_name || ""; 
        document.getElementById('blueNameInput').value = sData.blue_team_name || ""; 
        document.getElementById('teamCount').value = sData.member_count || 5; 
        updateTeamNames(); 
    }
    const { data: pData } = await sb.from('players').select('*').order('created_at', { ascending: true });
    cachedPlayers = pData || []; rebuild(pData);
}
async function applyToSupabase() {
    const cards = document.querySelectorAll('.member-card');
    const toUpdate = [];
    for (const card of cards) {
        const isManual = card.querySelector('.tier-override').checked;
        const tSelect = card.querySelector('.tier-select');
        const lpVal = card.querySelector('.lp-input').value;
        const tierStr = isManual ? `${TIER_MAP[tSelect.value]} - ${lpVal}LP` : (cachedPlayers.find(p => p.id === card.dataset.uuid)?.tier || "ì–¸ë­í¬");
        
        let recent = [], champs = [];
        card.querySelectorAll('.history-item').forEach(item => {
            const btn = item.querySelector('.btn-toggle');
            recent.push(btn.innerText.includes('ìŠ¹ë¦¬') ? 'win' : (btn.innerText.includes('íŒ¨ë°°') ? 'lose' : 'ing'));
            champs.push(item.querySelector('.champ-input').value || 'None');
        });

        toUpdate.push({
            id: card.dataset.uuid, tier: tierStr, manual_tier: isManual,
            wins: Number(card.querySelector('.win-val').value), losses: Number(card.querySelector('.lose-val').value),
            recent: recent, champions: champs
        });
    }
    await sb.from('players').upsert(toUpdate);
    alert('ë°˜ì˜ ì™„ë£Œ');
}
async function start() { await initChampMap(); await loadData(); }
start();
</script>
</body>
</html>













