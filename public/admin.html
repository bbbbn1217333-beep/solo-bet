<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° - ê´€ë¦¬ì íŒ¨ë„ (UI ë³µêµ¬íŒ)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@600;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<style>
    :root { 
        --bg: #0b0e14; --card: #161a23; --gold: #ffd369; --red: #ff5c5c; --blue: #4db8ff; 
        --border: rgba(255,255,255,0.1); --input-bg: rgba(0,0,0,0.4); 
    }
    body { 
        background: var(--bg); color: #fff; font-family: 'Pretendard', sans-serif; 
        margin: 0; padding: 20px; line-height: 1.5;
    }
    
    /* ìƒë‹¨ í—¤ë” ìŠ¤íƒ€ì¼ */
    .header { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 25px; background: linear-gradient(145deg, #1e232b, #161a23);
        padding: 25px; border-radius: 16px; border: 1px solid var(--border);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .header-title { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 800; color: var(--gold); }

    .team-container { display: flex; gap: 25px; margin-bottom: 100px; }
    .team-section { 
        flex: 1; background: var(--card); border-radius: 20px; padding: 20px; 
        border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .team-title { 
        font-family: 'Orbitron', sans-serif; font-size: 22px; font-weight: 800; 
        margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);
        text-align: center; letter-spacing: 2px;
    }
    .red .team-title { color: var(--red); text-shadow: 0 0 10px rgba(255,92,92,0.3); }
    .blue .team-title { color: var(--blue); text-shadow: 0 0 10px rgba(77,184,255,0.3); }
    
    /* ë©¤ë²„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .member-card { 
        background: rgba(255,255,255,0.02); border: 1px solid var(--border); 
        border-radius: 12px; padding: 18px; margin-bottom: 18px;
        transition: all 0.3s ease;
    }
    .member-card:hover { border-color: rgba(255,211,105,0.3); background: rgba(255,255,255,0.04); }
    
    .name-row { display: flex; gap: 12px; margin-bottom: 15px; align-items: flex-end; }
    .input-group { display: flex; flex-direction: column; gap: 6px; flex: 1; }
    .input-group label { font-size: 11px; color: #888; font-weight: 800; text-transform: uppercase; }
    
    input, select { 
        background: var(--input-bg); border: 1px solid var(--border); color: #fff; 
        padding: 10px; border-radius: 6px; font-size: 13px; outline: none;
        transition: border 0.2s;
    }
    input:focus { border-color: var(--gold); }
    
    /* ì „ì  ì—ë””í„° ìŠ¤íƒ€ì¼ */
    .history-editor { 
        display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
        margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; 
    }
    .history-item { 
        display: flex; flex-direction: column; gap: 5px; background: rgba(0,0,0,0.3); 
        padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);
    }
    .history-item span { font-size: 10px; color: #666; font-weight: 800; text-align: center; }
    .champ-input { padding: 4px; font-size: 11px; text-align: center; }
    
    .btn-toggle { 
        border: none; padding: 6px; border-radius: 4px; cursor: pointer; 
        font-size: 11px; font-weight: 800; transition: 0.2s;
    }
    .btn-toggle.win { background: rgba(255,211,105,0.15); color: var(--gold); border: 1px solid var(--gold); }
    .btn-toggle.lose { background: rgba(255,92,92,0.15); color: var(--red); border: 1px solid var(--red); }
    .btn-toggle.ing { background: #222; color: #888; border: 1px solid #444; }

    /* í•˜ë‹¨ ê³ ì • ì»¨íŠ¸ë¡¤ ë°” */
    .controls { 
        position: fixed; bottom: 0; left: 0; right: 0; 
        background: rgba(22, 26, 35, 0.95); backdrop-filter: blur(10px);
        padding: 20px 40px; display: flex; justify-content: flex-end; gap: 20px; 
        border-top: 1px solid var(--gold); z-index: 1000;
        box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
    }
    button.main-btn { 
        padding: 14px 30px; border-radius: 10px; border: none; font-size: 15px;
        font-weight: 800; cursor: pointer; transition: all 0.3s;
    }
    .btn-apply { 
        background: var(--gold); color: #000; 
        box-shadow: 0 0 15px rgba(255,211,105,0.3);
    }
    .btn-apply:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(255,211,105,0.5); }
    
    .score-input-wrap { display: flex; flex-direction: column; gap: 4px; width: 50px; }
    .score-input { text-align: center; font-weight: 800; color: var(--gold); }
    .status-msg { font-size: 11px; font-weight: 700; }
</style>
</head>
<body>

<div class="header">
    <div class="header-title">SOLO RANK BET MANAGER</div>
    <div style="display:flex; gap:20px;">
        <div class="input-group">
            <label>ì¢…ë£Œ ì¼ì‹œ</label>
            <input type="datetime-local" id="endDateTime">
        </div>
        <div class="input-group">
            <label>íŒ€ë³„ ì¸ì›</label>
            <select id="teamCount" onchange="resetTeams()">
                <option value="1">1ëª…</option><option value="2">2ëª…</option><option value="3">3ëª…</option><option value="4" selected>4ëª…</option><option value="5">5ëª…</option>
            </select>
        </div>
    </div>
    <div style="display:flex; gap:15px;">
        <input type="text" id="redNameInput" placeholder="ë ˆë“œíŒ€ ëª…ì¹­" value="RED TEAM" style="color:var(--red); border-color:var(--red); width: 140px;">
        <input type="text" id="blueNameInput" placeholder="ë¸”ë£¨íŒ€ ëª…ì¹­" value="BLUE TEAM" style="color:var(--blue); border-color:var(--blue); width: 140px;">
    </div>
</div>

<div class="team-container">
    <div class="team-section red" id="redTeam">
        <div class="team-title">RED TEAM</div>
        <div class="member-list"></div>
    </div>
    <div class="team-section blue" id="blueTeam">
        <div class="team-title">BLUE TEAM</div>
        <div class="member-list"></div>
    </div>
</div>

<div class="controls">
    <button class="main-btn" style="background:#333; color:#eee;" onclick="loadFromSupabase()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
    <button class="main-btn btn-apply" onclick="applyToSupabase()">â˜… ì†¡ì¶œ í™”ë©´ ë°˜ì˜ â˜…</button>
</div>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = {
    "CHALLENGER": "ì±Œë¦°ì €", "GRANDMASTER": "ê·¸ëœë“œë§ˆìŠ¤í„°", "MASTER": "ë§ˆìŠ¤í„°",
    "DIAMOND": "ë‹¤ì´ì•„ëª¬ë“œ", "EMERALD": "ì—ë©”ë„ë“œ", "PLATINUM": "í”Œë˜í‹°ë„˜",
    "GOLD": "ê³¨ë“œ", "SILVER": "ì‹¤ë²„", "BRONZE": "ë¸Œë¡ ì¦ˆ", "IRON": "ì•„ì´ì–¸", "UNRANKED": "ì–¸ë­í¬"
};

let cachedPlayers = [];

function createMemberCard(team, data = null) {
    const card = document.createElement('div');
    card.className = 'member-card';
    card.dataset.team = team;
    card.dataset.puuid = data?.puuid || ""; 
    card.dataset.existingTier = data?.tier || "ì–¸ë­í¬";

    let historyHTML = '';
    for(let i=0; i<10; i++) {
        const champ = (data?.champions?.[i] === 'None' || !data?.champions?.[i]) ? '' : data.champions[i];
        const res = data?.recent?.[i] || 'ing';
        const resText = res === 'win' ? 'ğŸ˜ ìŠ¹ë¦¬' : (res === 'lose' ? 'ğŸ˜¡ íŒ¨ë°°' : 'ğŸ•’ ì§„í–‰');
        const resClass = res === 'win' ? 'win' : (res === 'lose' ? 'lose' : 'ing');
        historyHTML += `<div class="history-item"><span>${i+1} GAME</span><input type="text" class="champ-input" placeholder="ì±”í”¼ì–¸" value="${champ}"><button class="btn-toggle ${resClass}" onclick="toggleResult(this)">${resText}</button></div>`;
    }

    let currentTierEng = "UNRANKED";
    let currentLP = "";
    if (data?.tier && data.tier !== "ì–¸ë­í¬") {
        const mainTier = data.tier.split(' ')[0];
        currentTierEng = Object.keys(TIER_MAP).find(key => TIER_MAP[key] === mainTier) || "UNRANKED";
        const lpMatch = data.tier.match(/(\d+)LP/);
        currentLP = lpMatch ? lpMatch[1] : "";
    }

    const tierOptions = Object.entries(TIER_MAP).map(([eng, kor]) => `<option value="${eng}" ${currentTierEng === eng ? 'selected' : ''}>${kor}</option>`).join('');

    card.innerHTML = `
        <div class="name-row">
            <div class="input-group"><label>BJ NAME</label><input class="nick-disp" value="${data?.name || ''}"></div>
            <div class="input-group"><label>LOL ID (FOR API)</label><input class="nick-riot" placeholder="ë‹‰ë„¤ì„#íƒœê·¸" value="${data?.riot_id || ''}" onblur="fetchRiotData(this)"></div>
            <div class="input-group" style="flex: 1.2;">
                <label style="color:var(--gold); cursor:pointer;"><input type="checkbox" class="tier-override" ${data?.manual_tier ? 'checked' : ''} onchange="toggleLock(this)"> MANUAL EDIT</label>
                <select class="tier-select" ${data?.manual_tier ? '' : 'disabled'}>${tierOptions}</select>
            </div>
            <div class="input-group" style="flex:0.4;">
                <label>LP</label>
                <input class="lp-input" value="${currentLP}" ${data?.manual_tier ? '' : 'disabled'}>
            </div>
            <div class="score-input-wrap"><label>WIN</label><input class="score-input win-val" value="${data?.wins ?? ''}"></div>
            <div class="score-input-wrap"><label>LOSS</label><input class="score-input lose-val" value="${data?.losses ?? ''}"></div>
        </div>
        <div class="history-editor">${historyHTML}</div>
        <div class="status-msg" style="margin-top:8px; color:#666;"></div>`;
    return card;
}

function toggleResult(btn) {
    if(btn.classList.contains('ing')) { btn.className = 'btn-toggle win'; btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; }
    else if(btn.classList.contains('win')) { btn.className = 'btn-toggle lose'; btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; }
    else { btn.className = 'btn-toggle ing'; btn.innerText = 'ğŸ•’ ì§„í–‰'; }
}

function toggleLock(cb) {
    const card = cb.closest('.member-card');
    card.querySelector('.tier-select').disabled = !cb.checked;
    card.querySelector('.lp-input').disabled = !cb.checked;
}

async function fetchRiotData(input) {
    const val = input.value.trim();
    if(!val.includes('#')) return;
    const card = input.closest('.member-card');
    const msg = card.querySelector('.status-msg');
    msg.style.color = var(--gold);
    msg.innerText = "â³ API ë°ì´í„° ì¡°íšŒ ì¤‘...";

    try {
        const [name, tag] = val.split('#');
        const res = await fetch(`https://solrank-api-production.up.railway.app/api/summoner?name=${encodeURIComponent(name)}&tag=${encodeURIComponent(tag)}`);
        const d = await res.json();
        
        if(d.tier) {
            msg.style.color = "#4db8ff";
            msg.innerText = `âœ… ì¡°íšŒ ì„±ê³µ: ${d.tier} ${d.rank} (${d.leaguePoints}LP)`;
            
            const tierKor = TIER_MAP[d.tier] || d.tier;
            const finalStr = `${tierKor} ${d.rank} - ${d.leaguePoints}LP`;
            card.dataset.existingTier = finalStr;
            card.dataset.puuid = d.puuid;

            if(!card.querySelector('.tier-override').checked) {
                card.querySelector('.tier-select').value = d.tier;
                card.querySelector('.lp-input').value = d.leaguePoints;
            }
        } else {
            msg.style.color = var(--red);
            msg.innerText = "âŒ ì†Œí™˜ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
    } catch(e) {
        msg.innerText = "âŒ API ì„œë²„ ì‘ë‹µ ì—†ìŒ";
    }
}

async function applyToSupabase() {
    const playersUpdateList = [];
    let cutsceneAssigned = false;

    document.querySelectorAll('.member-card').forEach(card => {
        const name = card.querySelector('.nick-disp').value.trim();
        if(!name) return;

        const recent = [], champs = [];
        card.querySelectorAll('.history-item').forEach(item => {
            recent.push(item.querySelector('.btn-toggle').classList.contains('win') ? 'win' : (item.querySelector('.btn-toggle').classList.contains('lose') ? 'lose' : 'ing'));
            champs.push(item.querySelector('.champ-input').value.trim() || 'None');
        });

        const isManual = card.querySelector('.tier-override').checked;
        let finalTier = "";
        
        if(isManual) {
            const selTier = card.querySelector('.tier-select').value;
            const lp = card.querySelector('.lp-input').value.trim();
            if(selTier === "UNRANKED") finalTier = "ì–¸ë­í¬";
            else finalTier = lp ? `${TIER_MAP[selTier]} - ${lp}LP` : TIER_MAP[selTier];
        } else {
            finalTier = card.dataset.existingTier || "ì–¸ë­í¬";
        }

        let trigger = false;
        if(!cutsceneAssigned) {
            const last = recent.filter(r => r === 'win' || r === 'lose').pop();
            const prevPlayer = cachedPlayers.find(p => p.name === name);
            const prevLast = prevPlayer?.recent?.filter(r => r === 'win' || r === 'lose').pop();
            if(last && last !== prevLast) { trigger = true; cutsceneAssigned = true; }
        }

        playersUpdateList.push({
            name, team: card.dataset.team, riot_id: card.querySelector('.nick-riot').value.trim(),
            puuid: card.dataset.puuid, tier: finalTier, manual_tier: isManual,
            wins: card.querySelector('.win-val').value !== '' ? Number(card.querySelector('.win-val').value) : recent.filter(r=>r==='win').length,
            losses: card.querySelector('.lose-val').value !== '' ? Number(card.querySelector('.lose-val').value) : recent.filter(r=>r==='lose').length,
            recent, champions: champs, trigger_cutscene: trigger
        });
    });

    try {
        await sb.from('settings').upsert({ 
            id: 1, 
            red_team_name: document.getElementById('redNameInput').value, 
            blue_team_name: document.getElementById('blueNameInput').value, 
            member_count: Number(document.getElementById('teamCount').value),
            timer_end_at: document.getElementById('endDateTime').value || null 
        });

        await sb.from('players').delete().not('name', 'eq', 'SAFE_DELETE_VAL');
        await new Promise(r => setTimeout(r, 200));
        await sb.from('players').insert(playersUpdateList);

        alert("ğŸš€ ì„±ê³µì ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!");
        cachedPlayers = JSON.parse(JSON.stringify(playersUpdateList));
    } catch(e) {
        alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
}

async function loadFromSupabase() {
    const { data: s } = await sb.from('settings').select('*').eq('id', 1).single();
    if(s) {
        document.getElementById('redNameInput').value = s.red_team_name;
        document.getElementById('blueNameInput').value = s.blue_team_name;
        document.getElementById('teamCount').value = s.member_count;
        if(s.timer_end_at) document.getElementById('endDateTime').value = s.timer_end_at.substring(0,16);
    }
    const { data: p } = await sb.from('players').select('*').order('created_at', {ascending:true});
    cachedPlayers = p || [];
    resetTeams(p);
}

function resetTeams(data = []) {
    const count = Number(document.getElementById('teamCount').value);
    const redList = document.querySelector('.red .member-list');
    const blueList = document.querySelector('.blue .member-list');
    redList.innerHTML = ''; blueList.innerHTML = '';
    
    for(let i=0; i<count; i++) {
        redList.appendChild(createMemberCard('red', data.filter(x => x.team==='red')[i]));
        blueList.appendChild(createMemberCard('blue', data.filter(x => x.team==='blue')[i]));
    }
}

loadFromSupabase();
</script>
</body>
</html>





















