<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° ì‹œíŠ¸ì§€ ê´€ë¦¬ììš©</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@600;800;900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
Â  Â  /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
Â  Â  :root {Â 
Â  Â  Â  Â  --red: #ff3b3b; --blue: #4db8ff; --gold: #ffd369;Â 
Â  Â  Â  Â  --emerald: #2ecc71;Â 
Â  Â  Â  Â  --neon-red: 0 0 15px rgba(255, 59, 59, 0.8);
Â  Â  Â  Â  --neon-blue: 0 0 15px rgba(77, 184, 255, 0.8);
Â  Â  Â  Â  --neon-gold: 0 0 20px rgba(255, 211, 105, 0.8);
Â  Â  }
Â  Â  body { margin:0; background:#0e0e0e; color:#fff; font-family:'Pretendard',sans-serif; padding:15px; padding-bottom: 120px; overflow-x: auto; }
Â  Â  .wrap { width: 1550px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
Â  Â  .admin-header { background:#1a1a1a; padding:25px; border-radius:15px; border: 2px solid var(--gold); box-shadow: var(--neon-gold); }
Â  Â  .top-controls { display:flex; gap:20px; align-items:flex-end; margin-bottom:20px; flex-wrap: nowrap; }
Â  Â  .header-group { display:flex; flex-direction:column; gap:8px; }
Â  Â  .label-red { font-size:15px; font-weight:900; color:var(--red) !important; text-shadow: 0 0 8px rgba(255,59,59,0.5); }
Â  Â  .label-blue { font-size:15px; font-weight:900; color:var(--blue) !important; text-shadow: 0 0 8px rgba(77,184,255,0.5); }
Â  Â  .label-gold { font-size:15px; font-weight:900; color:var(--gold); text-shadow: 0 0 8px rgba(255,211,105,0.5); }
Â  Â  .top-controls input, .timer-input-wrap, .btn-load-data { height: 50px !important; box-sizing: border-box; }
Â  Â  .top-controls input { padding:12px; background:#000; border-radius:8px; font-size:16px; font-weight:900; outline:none; border: 2px solid var(--gold); color: #fff; box-shadow: var(--neon-gold); }
Â  Â  .timer-input-wrap { display: flex; align-items: center; background: #000; padding: 0 15px; border-radius: 8px; border: 2px solid var(--gold); box-shadow: var(--neon-gold); width: 320px; }
Â  Â  #endDateTime { background: transparent; border: none; color: #fff; font-family: 'Pretendard'; font-weight: 900; font-size: 16px; outline: none; color-scheme: dark; width: 100%; box-shadow: none !important; }
Â  Â  #teamCount { width:90px; text-align: center; }
Â  Â  .btn-load-data { padding:0 25px; background:#000; color:var(--emerald); border:2px solid var(--emerald); border-radius:8px; cursor:pointer; font-weight:900; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); font-size: 15px; display: flex; align-items: center; justify-content: center; }
Â  Â  .menu-desc { font-size:14px; color:#ccc; line-height:1.8; background:#111; padding:22px; border-radius:10px; border: 2px solid var(--gold); box-shadow: inset 0 0 15px rgba(255,211,105,0.1), var(--neon-gold); margin-top: 10px; font-weight: 800; }
Â  Â  .menu-desc strong { color: var(--gold); font-size: 18px; text-shadow: 0 0 10px var(--gold); display: block; margin-bottom: 8px; font-weight: 900; }
Â  Â  .neon-point { color: var(--gold); text-shadow: 0 0 10px var(--gold); font-weight: 900; }
Â  Â  .teams-container { display:flex; gap:25px; width: 100%; }
Â  Â  .team-box { flex:1; background:#1a1a1a; padding:20px; border-radius:15px; border-top: 5px solid; min-width: 740px; }
Â  Â  .team-box.red { border-color: var(--red); box-shadow: 0 -5px 15px rgba(255, 59, 59, 0.3); }
Â  Â  .team-box.blue { border-color: var(--blue); box-shadow: 0 -5px 15px rgba(77, 184, 255, 0.3); }
Â  Â  .member-list { display:flex; flex-direction:column; gap:20px; max-height:850px; overflow-y:auto; padding: 10px; }
Â  Â  .member-card { background:#151515; border-radius:12px; padding:20px; border: 2px solid; margin-bottom: 5px; }
Â  Â  .red .member-card { border-color: var(--red); box-shadow: var(--neon-red); }
Â  Â  .blue .member-card { border-color: var(--blue); box-shadow: var(--neon-blue); }
Â  Â  .name-row { display:flex; gap:8px; margin-bottom:15px; align-items: flex-end; }
Â  Â  .input-group { display: flex; flex-direction: column; align-items: center; }
Â  Â  .input-group label { font-size:12px; font-weight:900; color:#fff; margin-bottom: 6px; text-align: center; white-space: nowrap; }
Â  Â  .nick-disp, .nick-riot, .lp-input, .score-input { height: 44px !important; box-sizing: border-box !important; }
Â  Â Â 
Â  Â  .tier-select {Â 
Â  Â  Â  Â  height: 44px !important; width: 100%; box-sizing: border-box !important; padding: 0 10px; background:#000; border: 2px solid var(--gold) !important; border-radius:6px; font-size:14px; font-weight: 900; color: var(--gold) !important; box-shadow: var(--neon-gold); outline:none; text-align: center; appearance: none;Â 
Â  Â  }
Â  Â Â 
Â  Â  .tier-select[data-tier^="ì±Œë¦°ì €"] { color: #ff4e50 !important; border-color: #ff4e50 !important; box-shadow: 0 0 10px rgba(255,78,80,0.5) !important; }
Â  Â  .tier-select[data-tier^="ê·¸ëœë“œë§ˆìŠ¤í„°"] { color: #ff7f7f !important; border-color: #ff7f7f !important; }
Â  Â  .tier-select[data-tier^="ë§ˆìŠ¤í„°"] { color: #e3a3ff !important; border-color: #e3a3ff !important; }
Â  Â  .tier-select[data-tier^="ë‹¤ì´ì•„ëª¬ë“œ"] { color: #57bbff !important; border-color: #57bbff !important; }
Â  Â  .tier-select[data-tier^="ì—ë©”ë„ë“œ"] { color: #2ecc71 !important; border-color: #2ecc71 !important; }
Â  Â  .tier-select[data-tier^="í”Œë˜í‹°ë„˜"] { color: #4ecdc4 !important; border-color: #4ecdc4 !important; }
Â  Â  .tier-select[data-tier^="ê³¨ë“œ"] { color: #f1c40f !important; border-color: #f1c40f !important; }
Â  Â  .tier-select[data-tier^="ì‹¤ë²„"] { color: #bdc3c7 !important; border-color: #bdc3c7 !important; }
Â  Â  .tier-select[data-tier^="ë¸Œë¡ ì¦ˆ"] { color: #a67c52 !important; border-color: #a67c52 !important; }
Â  Â  .tier-select[data-tier^="ì•„ì´ì–¸"] { color: #7f8c8d !important; border-color: #7f8c8d !important; }
Â  Â  .tier-select[data-tier="ì–¸ë­í¬"] { color: #fff !important; border-color: var(--gold) !important; }

Â  Â  .nick-disp { width: 110px !important; padding:10px; background:#000; border-radius:6px; font-size:14px; font-weight: 900 !important; color: #fff; outline:none; text-align: center; border: 2px solid; }
Â  Â  .nick-riot { flex: 2 !important; min-width: 150px; padding:10px; background:#000; border-radius:6px; font-size:14px; font-weight: 900 !important; color: #fff; outline:none; text-align: center; border: 2px solid; }
Â  Â  .red .nick-disp, .red .nick-riot { border-color: var(--red); }
Â  Â  .blue .nick-disp, .blue .nick-riot { border-color: var(--blue); }
Â  Â  .lp-input { width: 65px !important; background:#000; border: 2px solid var(--gold) !important; border-radius:6px; color: var(--gold) !important; text-align: center; font-weight: 900; box-shadow: var(--neon-gold); outline:none; }
Â  Â  .score-input-wrap { display:flex; flex-direction:column; align-items: center; width:45px; flex: none !important; margin-left: 2px !important; }
Â  Â  .score-input-wrap label { font-size: 11px; font-weight: 900; margin-bottom: 6px; }
Â  Â  .score-input { width: 100%; text-align:center; border-radius:6px; font-size:16px; font-weight: 900; outline: none; background:#000; padding: 0 !important; }
Â  Â  .win-val { border: 2px solid var(--gold) !important; box-shadow: var(--neon-gold); color: var(--gold); }
Â  Â  .lose-val { border: 2px solid var(--red) !important; box-shadow: var(--neon-red); color: var(--red); }
Â  Â  .history-editor { display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; background:#0c0c0c; padding:15px; border-radius:10px; }
Â  Â  .history-item { display:flex; flex-direction:column; gap:6px; align-items:center; padding: 10px 5px; border-radius: 8px; border: 2px solid; }
Â  Â  .red .history-item { border-color: var(--red); box-shadow: var(--neon-red); }
Â  Â  .blue .history-item { border-color: var(--blue); box-shadow: var(--neon-blue); }
Â  Â  .history-item span { color: var(--gold); text-shadow: 0 0 8px var(--gold); font-weight: 900; font-size: 12px; }
Â  Â  .champ-input { width:92%; background:#000; border: 2px solid var(--gold); color:#fff; text-align:center; padding:8px 0; border-radius:5px; font-size:12px; font-weight: 800; box-shadow: var(--neon-gold); outline: none; }
Â  Â  .btn-toggle { width:100%; padding:8px 0; font-size:11px; font-weight:900; border:none; border-radius:4px; cursor:pointer; }
Â  Â  .btn-toggle.win { background: var(--gold); color: #000; }
Â  Â  .btn-toggle.lose { background: var(--red); color: #fff; }
Â  Â  .btn-toggle.ing { background: var(--emerald); color: #fff; }
Â  Â  .btn-apply { position: fixed; bottom: 30px; right: 30px; z-index: 1000; width: 280px; height: 70px; font-size:24px; font-weight:900; background: var(--red); color:#fff; border:none; border-radius:15px; cursor:pointer; box-shadow: 0 0 30px rgba(255, 59, 59, 0.7); }
</style>
</head>
<body>

<div class="wrap">
Â  Â  <div class="admin-header">
Â  Â  Â  Â  <div class="top-controls">
Â  Â  Â  Â  Â  Â  <div class="header-group"><label class="label-red">ğŸš© ë ˆë“œ íŒ€ ëª…ì¹­</label><input id="redNameInput" oninput="updateTeamNames()" placeholder="ë ˆë“œ íŒ€"></div>
Â  Â  Â  Â  Â  Â  <div class="header-group"><label class="label-blue">ğŸš© ë¸”ë£¨ íŒ€ ëª…ì¹­</label><input id="blueNameInput" oninput="updateTeamNames()" placeholder="ë¸”ë£¨ íŒ€"></div>
Â  Â  Â  Â  Â  Â  <div class="header-group"><label class="label-gold">â° ëª©í‘œ ì¢…ë£Œ ì‹œê°„</label><div class="timer-input-wrap"><input id="endDateTime" type="datetime-local"></div></div>
Â  Â  Â  Â  Â  Â  <div class="header-group"><label class="label-gold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì¸ì›</label><input id="teamCount" type="number" min="1" max="33" value="5" onchange="rebuildWithCache()"></div>
Â  Â  Â  Â  Â  Â  <button id="watchBtn" class="btn-load-data" onclick="toggleWatch()" style="color:var(--gold); border-color:var(--gold); box-shadow: var(--neon-gold);">â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘</button>
Â  Â  Â  Â  Â  Â  <button class="btn-load-data" onclick="loadData()">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="menu-desc">
Â  Â  Â  Â  Â  Â  <strong>ğŸ’¡ ìë™ ê°ì‹œ ì•ˆë‚´</strong>
Â  Â  Â  Â  Â  Â  â€¢ <span class="neon-point">ì‹œì  í•„í„°:</span> ë²„íŠ¼ì„ ëˆ„ë¥¸ ì´ ì‹œì  ì´í›„ì— ì¢…ë£Œëœ ê²Œì„ë§Œ ì „ì ì— ê¸°ë¡ë©ë‹ˆë‹¤.<br>
Â  Â  Â  Â  Â  Â  â€¢ <span class="neon-point">í‹°ì–´ ê°±ì‹ :</span> ìˆ˜ë™ ìˆ˜ì • ì²´í¬ê°€ í•´ì œëœ ìœ ì €ëŠ” í‹°ì–´ê°€ ì‹¤ì‹œê°„ ë°˜ì˜ë©ë‹ˆë‹¤.
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="teams-container">
Â  Â  Â  Â  <div class="team-box red"><h2 id="redTitle" style="color:var(--red); text-shadow:var(--neon-red); font-weight:900; font-size:32px; margin-bottom:20px;">ë ˆë“œ íŒ€</h2><div id="redPlayers" class="member-list"></div></div>
Â  Â  Â  Â  <div class="team-box blue"><h2 id="blueTitle" style="color:var(--blue); text-shadow:var(--neon-blue); font-weight:900; font-size:32px; margin-bottom:20px;">ë¸”ë£¨ íŒ€</h2><div id="bluePlayers" class="member-list"></div></div>
Â  Â  </div>
</div>

<button class="btn-apply" onclick="applyToSupabase()">ì†¡ì¶œ í™”ë©´ ë°˜ì˜</button>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = {
Â  Â  "CHALLENGER": "ì±Œë¦°ì €", "GRANDMASTER": "ê·¸ëœë“œë§ˆìŠ¤í„°", "MASTER": "ë§ˆìŠ¤í„°",
Â  Â  "DIAMOND 1": "ë‹¤ì´ì•„ëª¬ë“œ 1", "DIAMOND 2": "ë‹¤ì´ì•„ëª¬ë“œ 2", "DIAMOND 3": "ë‹¤ì´ì•„ëª¬ë“œ 3", "DIAMOND 4": "ë‹¤ì´ì•„ëª¬ë“œ 4",
Â  Â  "EMERALD 1": "ì—ë©”ë„ë“œ 1", "EMERALD 2": "ì—ë©”ë„ë“œ 2", "EMERALD 3": "ì—ë©”ë„ë“œ 3", "EMERALD 4": "ì—ë©”ë„ë“œ 4",
Â  Â  "PLATINUM 1": "í”Œë˜í‹°ë„˜ 1", "PLATINUM 2": "í”Œë˜í‹°ë„˜ 2", "PLATINUM 3": "í”Œë˜í‹°ë„˜ 3", "PLATINUM 4": "í”Œë˜í‹°ë„˜ 4",
Â  Â  "GOLD 1": "ê³¨ë“œ 1", "GOLD 2": "ê³¨ë“œ 2", "GOLD 3": "ê³¨ë“œ 3", "GOLD 4": "ê³¨ë“œ 4",
Â  Â  "SILVER 1": "ì‹¤ë²„ 1", "SILVER 2": "ì‹¤ë²„ 2", "SILVER 3": "ì‹¤ë²„ 3", "SILVER 4": "ì‹¤ë²„ 4",
Â  Â  "BRONZE 1": "ë¸Œë¡ ì¦ˆ 1", "BRONZE 2": "ë¸Œë¡ ì¦ˆ 2", "BRONZE 3": "ë¸Œë¡ ì¦ˆ 3", "BRONZE 4": "ë¸Œë¡ ì¦ˆ 4",
Â  Â  "IRON 1": "ì•„ì´ì–¸ 1", "IRON 2": "ì•„ì´ì–¸ 2", "IRON 3": "ì•„ì´ì–¸ 3", "IRON 4": "ì•„ì´ì–¸ 4",
Â  Â  "UNRANKED": "ì–¸ë­í¬"
};

const TIER_RANK = { "ì±Œë¦°ì €":30, "ê·¸ëœë“œë§ˆìŠ¤í„°":29, "ë§ˆìŠ¤í„°":28, "ë‹¤ì´ì•„ëª¬ë“œ 1":27, "ë‹¤ì´ì•„ëª¬ë“œ 2":26, "ë‹¤ì´ì•„ëª¬ë“œ 3":25, "ë‹¤ì´ì•„ëª¬ë“œ 4":24, "ì—ë©”ë„ë“œ 1":23, "ì—ë©”ë„ë“œ 2":22, "ì—ë©”ë„ë“œ 3":21, "ì—ë©”ë„ë“œ 4":20, "í”Œë˜í‹°ë„˜ 1":19, "í”Œë˜í‹°ë„˜ 2":18, "í”Œë˜í‹°ë„˜ 3":17, "í”Œë˜í‹°ë„˜ 4":16, "ê³¨ë“œ 1":15, "ê³¨ë“œ 2":14, "ê³¨ë“œ 3":13, "ê³¨ë“œ 4":12, "ì‹¤ë²„ 1":11, "ì‹¤ë²„ 2":10, "ì‹¤ë²„ 3":9, "ì‹¤ë²„ 4":8, "ë¸Œë¡ ì¦ˆ 1":7, "ë¸Œë¡ ì¦ˆ 2":6, "ë¸Œë¡ ì¦ˆ 3":5, "ë¸Œë¡ ì¦ˆ 4":4, "ì•„ì´ì–¸ 1":3, "ì•„ì´ì–¸ 2":2, "ì•„ì´ì–¸ 3":1, "ì•„ì´ì–¸ 4":0, "ì–¸ë­í¬": -1 };

let cachedPlayers = [];
let autoSyncInterval = null;Â 
let champNameMap = {};Â 
let idToNameMap = {};Â 
let watchStartTime = null;Â 
let initialMatchCounts = {};Â 

async function initChampMap() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`https://ddragon.leagueoflegends.com/cdn/16.3.1/data/ko_KR/champion.json`);
Â  Â  Â  Â  const json = await res.json();
Â  Â  Â  Â  Object.values(json.data).forEach(c => {
Â  Â  Â  Â  Â  Â  champNameMap[c.id] = c.name;Â 
Â  Â  Â  Â  Â  Â  idToNameMap[c.key] = c.name;Â 
Â  Â  Â  Â  });
Â  Â  } catch (e) { console.error("ì±”í”¼ì–¸ ë¡œë“œ ì‹¤íŒ¨:", e); }
}

async function toggleWatch() {
Â  Â  const btn = document.getElementById('watchBtn');
Â  Â  if (autoSyncInterval) {
Â  Â  Â  Â  clearInterval(autoSyncInterval); autoSyncInterval = null;
Â  Â  Â  Â  btn.innerText = "â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘";
Â  Â  Â  Â  watchStartTime = null;
Â  Â  } else {
Â  Â  Â  Â  watchStartTime = Date.now();Â 

Â  Â  Â  Â  const cards = document.querySelectorAll('.member-card');
Â  Â  Â  Â  cards.forEach(card => {
Â  Â  Â  Â  Â  Â  const uuid = card.dataset.uuid;
Â  Â  Â  Â  Â  Â  if (uuid) {
Â  Â  Â  Â  Â  Â  Â  Â  initialMatchCounts[uuid] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wins: parseInt(card.querySelector('.win-val').value) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  losses: parseInt(card.querySelector('.lose-val').value) || 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  btn.innerText = "â¹ï¸ ê°ì‹œ ì¤‘ (45ì´ˆ ì£¼ê¸°)";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // [ìˆ˜ì •] ê°ì‹œ ì‹œì‘ ì¦‰ì‹œ í‹°ì–´ ê°±ì‹  ì‹¤í–‰
Â  Â  Â  Â  await syncWithRiot();
Â  Â  Â  Â  autoSyncInterval = setInterval(syncWithRiot, 45000);Â 
Â  Â  }
}

async function syncWithRiot() {Â 
Â  Â  try {Â 
Â  Â  Â  Â  // 1. ì„œë²„ì— ë™ê¸°í™” ìš”ì²­ (ê°ì‹œ ì¤‘ì´ë©´ startTime ì „ë‹¬)
Â  Â  Â  Â  const syncUrl = watchStartTime ? `/api/sync?startTime=${watchStartTime}` : `/api/sync`;
Â  Â  Â  Â  await fetch(syncUrl);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. DBì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
Â  Â  Â  Â  const { data: pData } = await sb.from('players').select('*').order('created_at', { ascending: true });
Â  Â  Â  Â Â 
Â  Â  Â  Â  cachedPlayers = pData || [];
Â  Â  Â  Â  rebuild(cachedPlayers);Â 
Â  Â  } catch (e) { console.error("ë™ê¸°í™” ì‹¤íŒ¨:", e); }Â 
}

function updateTeamNames() {
Â  Â  document.getElementById('redTitle').innerText = document.getElementById('redNameInput').value || 'ë ˆë“œ íŒ€';
Â  Â  document.getElementById('blueTitle').innerText = document.getElementById('blueNameInput').value || 'ë¸”ë£¨ íŒ€';
}

function toggleResult(btn) {
Â  Â  if (btn.innerText.includes('ìŠ¹ë¦¬')) { btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; btn.className = 'btn-toggle lose'; }
Â  Â  else if (btn.innerText.includes('íŒ¨ë°°')) { btn.innerText = 'ğŸ•’ ì§„í–‰'; btn.className = 'btn-toggle ing'; }
Â  Â  else { btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; btn.className = 'btn-toggle win'; }
}

function createMemberCard(team, data = null) {
Â  Â  const card = document.createElement('div');
Â  Â  card.className = 'member-card'; card.dataset.team = team; card.dataset.uuid = data?.id || "";Â 
Â  Â  let historyHTML = '';
Â  Â  for(let i=0; i<10; i++) {
Â  Â  Â  Â  let rawChamp = data?.champions?.[i];
Â  Â  Â  Â  let champDisp = '';
Â  Â  Â  Â  if (rawChamp && rawChamp !== 'None') {
Â  Â  Â  Â  Â  Â  if (idToNameMap[rawChamp]) champDisp = idToNameMap[rawChamp];
Â  Â  Â  Â  Â  Â  else if (champNameMap[rawChamp]) champDisp = champNameMap[rawChamp];
Â  Â  Â  Â  Â  Â  else champDisp = rawChamp;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = data?.recent?.[i] || 'ing';
Â  Â  Â  Â  const resText = res === 'win' ? 'ğŸ˜ ìŠ¹ë¦¬' : (res === 'lose' ? 'ğŸ˜¡ íŒ¨ë°°' : 'ğŸ•’ ì§„í–‰');
Â  Â  Â  Â  historyHTML += `<div class="history-item"><span>${i+1}íŒ</span><input type="text" class="champ-input" placeholder="ì±”í”¼ì–¸" value="${champDisp}"><button class="btn-toggle ${res === 'win'?'win':res==='lose'?'lose':'ing'}" onclick="toggleResult(this)">${resText}</button></div>`;
Â  Â  }
Â  Â Â 
Â  Â  let curTierEng = "UNRANKED", curLP = "";
Â  Â  if (data?.tier && !data.tier.includes("ì–¸ë­í¬")) {
Â  Â  Â  Â  const tierPart = data.tier.split(' - ')[0];
Â  Â  Â  Â  curTierEng = Object.keys(TIER_MAP).find(key => TIER_MAP[key] === tierPart) || "UNRANKED";
Â  Â  Â  Â  curLP = data.tier.match(/(\d+)LP/)?.[1] || "";
Â  Â  }
Â  Â  const tierOptions = Object.entries(TIER_MAP).map(([eng, kor]) => `<option value="${eng}" ${curTierEng === eng ? 'selected' : ''}>${kor}</option>`).join('');
Â  Â Â 
Â  Â  card.innerHTML = `
Â  Â  Â  Â  <div class="name-row">
Â  Â  Â  Â  Â  Â  <div class="input-group"><label>ìŠ¤íŠ¸ë¦¬ë¨¸</label><input class="nick-disp" placeholder="ë‹‰ë„¤ì„" value="${data?.name || ''}"></div>
Â  Â  Â  Â  Â  Â  <div class="input-group" style="flex:2;"><label>ë¡¤ ë‹‰ë„¤ì„</label><input class="nick-riot" placeholder="ë‹‰ë„¤ì„#íƒœê·¸" value="${data?.riot_id || ''}"></div>
Â  Â  Â  Â  Â  Â  <div class="input-group" style="flex:1.8;"><label style="color:var(--gold);"><input type="checkbox" class="tier-override" ${data?.manual_tier ? 'checked' : ''}> ìˆ˜ì •</label><select class="tier-select" ${data?.manual_tier ? '' : 'disabled'} style="opacity:${data?.manual_tier ? '1' : '0.4'};">${tierOptions}</select></div>
Â  Â  Â  Â  Â  Â  <div class="input-group" style="width:75px;"><label style="color:var(--gold);"><input type="checkbox" class="lp-override" ${data?.manual_tier ? 'checked' : ''}> ìˆ˜ì •</label><input class="lp-input" placeholder="0" value="${curLP}" ${data?.manual_tier ? '' : 'disabled'} style="opacity:${data?.manual_tier ? '1' : '0.4'};"></div>
Â  Â  Â  Â  Â  Â  <div class="score-input-wrap"><label style="color:var(--gold);">ìŠ¹</label><input class="score-input win-val" value="${data?.wins ?? 0}"></div>
Â  Â  Â  Â  Â  Â  <div class="score-input-wrap"><label style="color:var(--red);">íŒ¨</label><input class="score-input lose-val" value="${data?.losses ?? 0}"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="history-editor">${historyHTML}</div>`;
Â  Â Â 
Â  Â  const tCheck = card.querySelector('.tier-override');
Â  Â  const lCheck = card.querySelector('.lp-override');
Â  Â  const tSelect = card.querySelector('.tier-select');
Â  Â  const lInput = card.querySelector('.lp-input');
Â  Â Â 
Â  Â  const updateTierColor = () => {
Â  Â  Â  Â  const selectedText = tSelect.options[tSelect.selectedIndex].text;
Â  Â  Â  Â  tSelect.setAttribute('data-tier', selectedText);
Â  Â  };
Â  Â  tSelect.addEventListener('change', updateTierColor);
Â  Â  updateTierColor();Â 

Â  Â  [tCheck, lCheck].forEach(c => c.addEventListener('change', () => {
Â  Â  Â  Â  const active = tCheck.checked || lCheck.checked;
Â  Â  Â  Â  tSelect.disabled = !active; lInput.disabled = !active;
Â  Â  Â  Â  tSelect.style.opacity = active ? "1" : "0.4";
Â  Â  Â  Â  lInput.style.opacity = active ? "1" : "0.4";
Â  Â  }));

Â  Â  card.dataset.existingTier = data?.tier || "ì–¸ë­í¬";
Â  Â  return card;
}

function rebuildWithCache() { rebuild(cachedPlayers); }
function rebuild(dataList = null) {
Â  Â  const redWrap = document.getElementById('redPlayers'); const blueWrap = document.getElementById('bluePlayers'); const count = Number(document.getElementById('teamCount').value);
Â  Â  redWrap.innerHTML = ''; blueWrap.innerHTML = '';
Â  Â  const reds = dataList?.filter(p => p.team === 'red') || [];
Â  Â  const blues = dataList?.filter(p => p.team === 'blue') || [];
Â  Â  for(let i=0; i<count; i++) { redWrap.appendChild(createMemberCard('red', reds[i])); blueWrap.appendChild(createMemberCard('blue', blues[i])); }
}

async function loadData() {
Â  Â  try {
Â  Â  Â  Â  const { data: sData } = await sb.from('settings').select('*').eq('id', 1).single();
Â  Â  Â  Â  if (sData) {Â 
Â  Â  Â  Â  Â  Â  document.getElementById('redNameInput').value = sData.red_team_name || "";Â 
Â  Â  Â  Â  Â  Â  document.getElementById('blueNameInput').value = sData.blue_team_name || "";Â 
Â  Â  Â  Â  Â  Â  document.getElementById('teamCount').value = sData.member_count || 5;Â 
Â  Â  Â  Â  Â  Â  if(sData.timer_end_at) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(sData.timer_end_at);Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('endDateTime').value = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  updateTeamNames();Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  const { data: pData } = await sb.from('players').select('*').order('created_at', { ascending: true });
Â  Â  Â  Â  cachedPlayers = pData || []; rebuild(pData);
Â  Â  } catch (e) { console.error(e); }
}

async function applyToSupabase() {
Â  Â  const applyBtn = document.querySelector('.btn-apply');
Â  Â  const originalText = applyBtn.innerText;
Â  Â Â 
Â  Â  // [ìˆ˜ì •] ë°˜ì˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ê°±ì‹  ì‹œì‘ ì•Œë¦¼
Â  Â  applyBtn.innerText = "â³ í‹°ì–´ ê°±ì‹  ì¤‘...";
Â  Â  applyBtn.disabled = true;

Â  Â  // 1. ë¼ì´ì—‡ API ì¦‰ì‹œ ë™ê¸°í™” ì‹¤í–‰
Â  Â  await syncWithRiot();

Â  Â  const toUpdate = [];Â 
Â  Â  let cutsceneAssigned = false;
Â  Â  const cards = document.querySelectorAll('.member-card');
Â  Â Â 
Â  Â  for (const card of cards) {
Â  Â  Â  Â  const name = card.querySelector('.nick-disp').value.trim();
Â  Â  Â  Â  if (!name) continue;

Â  Â  Â  Â  const cardUuid = card.dataset.uuid;
Â  Â  Â  Â  const existingPlayer = cachedPlayers.find(p => p.id === cardUuid);

Â  Â  Â  Â  let recent = [], champs = [];
Â  Â  Â  Â  card.querySelectorAll('.history-item').forEach(item => {
Â  Â  Â  Â  Â  Â  const btn = item.querySelector('.btn-toggle');
Â  Â  Â  Â  Â  Â  recent.push(btn.innerText.includes('ìŠ¹ë¦¬') ? 'win' : (btn.innerText.includes('íŒ¨ë°°') ? 'lose' : 'ing'));
Â  Â  Â  Â  Â  Â  let rawChamp = item.querySelector('.champ-input').value.trim() || 'None';
Â  Â  Â  Â  Â  Â  const engKey = Object.keys(champNameMap).find(key => champNameMap[key] === rawChamp);
Â  Â  Â  Â  Â  Â  champs.push(engKey || rawChamp);
Â  Â  Â  Â  });

Â  Â  Â  Â  const currentWins = Number(card.querySelector('.win-val').value);
Â  Â  Â  Â  const currentLosses = Number(card.querySelector('.lose-val').value);

Â  Â  Â  Â  // [ìˆ˜ì •] ìˆ˜ë™ ìˆ˜ì • ì²´í¬ ì—¬ë¶€ì— ë”°ë¥¸ í‹°ì–´ ê²°ì • ë¡œì§ ê°•í™”
Â  Â  Â  Â  const isManual = card.querySelector('.tier-override').checked || card.querySelector('.lp-override').checked;
Â  Â  Â  Â  let finalTierStr;
Â  Â  Â  Â  if (isManual) {
Â  Â  Â  Â  Â  Â  const tEng = card.querySelector('.tier-select').value;
Â  Â  Â  Â  Â  Â  const lpVal = card.querySelector('.lp-input').value.trim();
Â  Â  Â  Â  Â  Â  finalTierStr = (lpVal && tEng !== "UNRANKED") ? `${TIER_MAP[tEng]} - ${lpVal}LP` : TIER_MAP[tEng];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // ìë™ ëª¨ë“œì¼ ê²½ìš° ë°©ê¸ˆ ë™ê¸°í™”ëœ DBì˜ ìµœì‹  í‹°ì–´ë¥¼ ìš°ì„  ì‚¬ìš©
Â  Â  Â  Â  Â  Â  finalTierStr = existingPlayer ? existingPlayer.tier : (card.dataset.existingTier || "ì–¸ë­í¬");
Â  Â  Â  Â  }

Â  Â  Â  Â  let trigger = false, event = null, lpDiff = "", targetChamp = "None";
Â  Â  Â  Â  const lastIdx = recent.findLastIndex(r => r === 'win' || r === 'lose');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!cutsceneAssigned && lastIdx !== -1 && cardUuid && initialMatchCounts[cardUuid]) {
Â  Â  Â  Â  Â  Â  const initData = initialMatchCounts[cardUuid];
Â  Â  Â  Â  Â  Â  const hasNewMatch = (currentWins + currentLosses) > (initData.wins + initData.losses);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (hasNewMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  trigger = true; cutsceneAssigned = true; targetChamp = champs[lastIdx];
Â  Â  Â  Â  Â  Â  Â  Â  if (existingPlayer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oldLP = parseInt(existingPlayer.tier?.match(/(\d+)LP/)?.[1] || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newLP = parseInt(finalTierStr.match(/(\d+)LP/)?.[1] || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diff = newLP - oldLP;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lpDiff = (diff >= 0) ? `+${diff}LP` : `${diff}LP`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oldRank = TIER_RANK[existingPlayer.tier?.split(' - ')[0]] ?? -1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newRank = TIER_RANK[finalTierStr.split(' - ')[0]] ?? -1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (recent[lastIdx] === 'win') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newRank > oldRank) event = (finalTierStr.split(' ')[0] !== existingPlayer.tier?.split(' ')[0]) ? 'promotion_major' : 'promotion';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else event = 'victory';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event = (newRank < oldRank) ? 'demotion' : 'defeat';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  initialMatchCounts[cardUuid] = { wins: currentWins, losses: currentLosses };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const playerData = {
Â  Â  Â  Â  Â  Â  "id": cardUuid,
Â  Â  Â  Â  Â  Â  "name": name,
Â  Â  Â  Â  Â  Â  "team": card.dataset.team,
Â  Â  Â  Â  Â  Â  "riot_id": card.querySelector('.nick-riot').value.trim(),
Â  Â  Â  Â  Â  Â  "tier": finalTierStr,
Â  Â  Â  Â  Â  Â  "manual_tier": isManual,
Â  Â  Â  Â  Â  Â  "wins": currentWins,
Â  Â  Â  Â  Â  Â  "losses": currentLosses,
Â  Â  Â  Â  Â  Â  "recent": recent,
Â  Â  Â  Â  Â  Â  "champions": champs,
Â  Â  Â  Â  Â  Â  "trigger_cutscene": trigger,
Â  Â  Â  Â  Â  Â  "event_type": event,
Â  Â  Â  Â  Â  Â  "lp_diff": lpDiff,
Â  Â  Â  Â  Â  Â  "target_champion": targetChamp
Â  Â  Â  Â  };
Â  Â  Â  Â  if (cardUuid) toUpdate.push(playerData);
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  await sb.from('settings').upsert({ id: 1, red_team_name: document.getElementById('redNameInput').value, blue_team_name: document.getElementById('blueNameInput').value, member_count: Number(document.getElementById('teamCount').value), timer_end_at: document.getElementById('endDateTime').value ? new Date(document.getElementById('endDateTime').value).toISOString() : null });
Â  Â  Â  Â  if (toUpdate.length > 0) await sb.from('players').upsert(toUpdate);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // UI ê°±ì‹  (ìµœì‹  í‹°ì–´ê°€ í™”ë©´ì— ë°˜ì˜ë˜ë„ë¡)
Â  Â  Â  Â  rebuild(toUpdate);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!autoSyncInterval) alert('âœ… ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
Â  Â  } catch (e) {Â 
Â  Â  Â  Â  console.error(e);Â 
Â  Â  } finally {
Â  Â  Â  Â  applyBtn.innerText = originalText;
Â  Â  Â  Â  applyBtn.disabled = false;
Â  Â  }
}

async function start() { await initChampMap(); await loadData(); }
start();
</script>
</body>
</html>















