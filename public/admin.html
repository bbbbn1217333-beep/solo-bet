<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° ì‹œíŠ¸ì§€ ê´€ë¦¬ììš©</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@600;800;900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #ff3b3b; --blue: #4db8ff; --gold: #ffd369; --emerald: #2ecc71; --neon-red: 0 0 15px rgba(255, 59, 59, 0.8); --neon-blue: 0 0 15px rgba(77, 184, 255, 0.8); --neon-gold: 0 0 20px rgba(255, 211, 105, 0.8); }
        body { margin:0; background:#0e0e0e; color:#fff; font-family:'Pretendard',sans-serif; padding:15px; padding-bottom: 120px; overflow-x: auto; }
        .wrap { width: 1600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .admin-header { background:#1a1a1a; padding:15px 25px; border-radius:15px; border: 2px solid var(--gold); box-shadow: var(--neon-gold); }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ 1ì¤„ ë°°ì¹˜ */
        .top-controls { display:flex; gap:12px; align-items:flex-end; flex-wrap: nowrap; }
        .header-group { display:flex; flex-direction:column; gap:6px; flex-shrink: 0; }
        .label-red, .label-blue, .label-gold { font-size:13px; font-weight:900; }
        .label-red { color:var(--red) !important; }
        .label-blue { color:var(--blue) !important; }
        .label-gold { color:var(--gold); }
        
        .top-controls input, .timer-input-wrap, .btn-load-data { height: 42px !important; box-sizing: border-box; }
        .top-controls input { padding:0 10px; background:#000; border-radius:6px; font-size:14px; font-weight:900; outline:none; border: 2px solid var(--gold); color: #fff; }
        .timer-input-wrap { display: flex; align-items: center; background: #000; padding: 0 10px; border-radius: 6px; border: 2px solid var(--gold); width: 230px; }
        #endDateTime { background: transparent; border: none; color: #fff; font-size: 14px; outline: none; color-scheme: dark; width: 100%; }
        #teamCount { width:60px; text-align: center; }
        
        /* ë²„íŠ¼ ìŠ¬ë¦¼í™” */
        .btn-load-data { padding:0 15px; background:#000; color:var(--emerald); border:2px solid var(--emerald); border-radius:6px; cursor:pointer; font-weight:900; font-size: 13px; white-space: nowrap; }
        .btn-reset-all { height: 42px; padding:0 15px; background:#000; color:var(--red); border:2px solid var(--red); border-radius:6px; cursor:pointer; font-weight:900; font-size: 13px; white-space: nowrap; }
        #watchBtn { color:var(--gold); border-color:var(--gold); box-shadow: var(--neon-gold); min-width: 110px; }

        .menu-desc { font-size:13px; color:#ccc; background:#111; padding:12px 20px; border-radius:10px; border: 1px solid #333; margin-top: 10px; font-weight: 700; display: flex; gap: 20px; align-items: center; }
        .menu-desc strong { color: var(--gold); }

        .teams-container { display:flex; gap:25px; width: 100%; }
        .team-box { flex:1; background:#1a1a1a; padding:20px; border-radius:15px; border-top: 5px solid; min-width: 760px; }
        .team-box.red { border-color: var(--red); }
        .team-box.blue { border-color: var(--blue); }
        .member-list { display:flex; flex-direction:column; gap:15px; }
        .member-card { background:#151515; border-radius:12px; padding:20px; border: 2px solid; position: relative; }
        .red .member-card { border-color: var(--red); }
        .blue .member-card { border-color: var(--blue); }

        /* ì…ë ¥ë€ ë° í‹°ì–´ ì„ íƒì°½ ê°œì„  */
        .name-row { display:flex; gap:10px; margin-bottom:15px; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; align-items: center; }
        .input-group label { font-size:11px; font-weight:900; margin-bottom: 6px; }
        
        .nick-disp, .nick-riot, .lp-input, .score-input { height: 40px !important; box-sizing: border-box !important; }
        
        /* í‹°ì–´ ê¸€ì ì•ˆì§¤ë¦¬ê²Œ ë„ˆë¹„ì™€ íŒ¨ë”© ì¡°ì • */
        .tier-select { height: 40px !important; width: 135px; padding: 0 5px; background:#000; border: 2px solid var(--gold) !important; border-radius:6px; font-size:13px; font-weight: 900; color: var(--gold) !important; text-align: center; outline:none; appearance: none; }
        
        .nick-disp { width: 100px !important; border: 2px solid; background:#000; color:#fff; border-radius:6px; text-align: center; font-weight:900; }
        .nick-riot { flex: 2; min-width: 150px; border: 2px solid; background:#000; color:#fff; border-radius:6px; text-align: center; font-weight:900; }
        .lp-input { width: 60px !important; background:#000; border: 2px solid var(--gold); border-radius:6px; color: var(--gold); text-align: center; font-weight: 900; }
        
        .score-input-wrap { display:flex; flex-direction:column; align-items: center; width:45px; }
        .score-input { width: 100%; text-align:center; border-radius:6px; font-size:16px; font-weight: 900; background:#000; border: 2px solid; }
        .win-val { border-color: var(--gold); color: var(--gold); }
        .lose-val { border-color: var(--red); color: var(--red); }

        /* ë¹—ìë£¨ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        .reset-wrap { display: flex; align-items: flex-end; padding-left: 5px; }
        .btn-reset-member { background: #222; border: 1px solid #444; color: #888; border-radius: 6px; cursor: pointer; font-size: 14px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-reset-member:hover { border-color: var(--red); color: var(--red); background: #331111; }

        .history-editor { display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; background:#0c0c0c; padding:15px; border-radius:10px; }
        .history-item { display:flex; flex-direction:column; gap:6px; align-items:center; padding: 10px 5px; border-radius: 8px; border: 1px solid #333; }
        .history-item span { color: var(--gold); font-weight: 900; font-size: 12px; }
        .champ-input { width:92%; background:#000; border: 1px solid var(--gold); color:#fff; text-align:center; padding:6px 0; border-radius:5px; font-size:12px; outline: none; }
        .btn-toggle { width:100%; padding:8px 0; font-size:11px; font-weight:900; border:none; border-radius:4px; cursor:pointer; }
        .btn-toggle.win { background: var(--gold); color: #000; }
        .btn-toggle.lose { background: var(--red); color: #fff; }
        .btn-toggle.ing { background: var(--emerald); color: #fff; }
        .btn-apply { position: fixed; bottom: 30px; right: 30px; z-index: 1000; width: 260px; height: 65px; font-size:22px; font-weight:900; background: var(--red); color:#fff; border:none; border-radius:15px; cursor:pointer; box-shadow: 0 0 30px rgba(255, 59, 59, 0.7); }
    </style>
</head>
<body>

<div class="wrap">
    <div class="admin-header">
        <div class="top-controls">
            <div class="header-group"><label class="label-red">ğŸš© ë ˆë“œ íŒ€</label><input id="redNameInput" oninput="updateTeamNames()" placeholder="ë ˆë“œ íŒ€"></div>
            <div class="header-group"><label class="label-blue">ğŸš© ë¸”ë£¨ íŒ€</label><input id="blueNameInput" oninput="updateTeamNames()" placeholder="ë¸”ë£¨ íŒ€"></div>
            <div class="header-group"><label class="label-gold">â° ì¢…ë£Œ ì‹œê°„</label><div class="timer-input-wrap"><input id="endDateTime" type="datetime-local"></div></div>
            <div class="header-group"><label class="label-gold">ğŸ‘¨â€ ì¸ì›</label><input id="teamCount" type="number" min="1" max="33" value="5" onchange="rebuildWithCache()"></div>
            <button id="watchBtn" class="btn-load-data" onclick="toggleWatch()">â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘</button>
            <button class="btn-load-data" onclick="loadData()">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-reset-all" onclick="resetAllRecords()">ğŸ§¹ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        <div class="menu-desc">
            <strong>ğŸ’¡ ì•ˆë‚´</strong>
            <span>â€¢ <b>ê°œë³„ ì´ˆê¸°í™”:</b> ë‹‰ë„¤ì„ ìœ ì§€, í‹°ì–´/ì „ì  ë¹„ì›€</span>
            <span>â€¢ <b>ì „ì²´ ì´ˆê¸°í™”:</b> ëª¨ë“  ë°ì´í„° ì™„ì „ ì‚­ì œ</span>
            <span>â€¢ <b>ìë™ ê°ì‹œ:</b> ê°ì‹œ ì‹œì‘ ì‹œì  ì´í›„ì˜ ì „ì ë§Œ í•˜ë‹¨ íŒì— ë°˜ì˜ë©ë‹ˆë‹¤.</span>
        </div>
    </div>

    <div class="teams-container">
        <div class="team-box red"><h2 id="redTitle" style="color:var(--red); font-weight:900; font-size:30px; margin-bottom:20px;">ë ˆë“œ íŒ€</h2><div id="redPlayers" class="member-list"></div></div>
        <div class="team-box blue"><h2 id="blueTitle" style="color:var(--blue); font-weight:900; font-size:30px; margin-bottom:20px;">ë¸”ë£¨ íŒ€</h2><div id="bluePlayers" class="member-list"></div></div>
    </div>
</div>

<button class="btn-apply" onclick="applyToSupabase()">ì†¡ì¶œ í™”ë©´ ë°˜ì˜</button>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = { "CHALLENGER": "ì±Œë¦°ì €", "GRANDMASTER": "ê·¸ëœë“œë§ˆìŠ¤í„°", "MASTER": "ë§ˆìŠ¤í„°", "DIAMOND 1": "ë‹¤ì´ì•„ëª¬ë“œ 1", "DIAMOND 2": "ë‹¤ì´ì•„ëª¬ë“œ 2", "DIAMOND 3": "ë‹¤ì´ì•„ëª¬ë“œ 3", "DIAMOND 4": "ë‹¤ì´ì•„ëª¬ë“œ 4", "EMERALD 1": "ì—ë©”ë„ë“œ 1", "EMERALD 2": "ì—ë©”ë„ë“œ 2", "EMERALD 3": "ì—ë©”ë„ë“œ 3", "EMERALD 4": "ì—ë©”ë„ë“œ 4", "PLATINUM 1": "í”Œë˜í‹°ë„˜ 1", "PLATINUM 2": "í”Œë˜í‹°ë„˜ 2", "PLATINUM 3": "í”Œë˜í‹°ë„˜ 3", "PLATINUM 4": "í”Œë˜í‹°ë„˜ 4", "GOLD 1": "ê³¨ë“œ 1", "GOLD 2": "ê³¨ë“œ 2", "GOLD 3": "ê³¨ë“œ 3", "GOLD 4": "ê³¨ë“œ 4", "SILVER 1": "ì‹¤ë²„ 1", "SILVER 2": "ì‹¤ë²„ 2", "SILVER 3": "ì‹¤ë²„ 3", "SILVER 4": "ì‹¤ë²„ 4", "BRONZE 1": "ë¸Œë¡ ì¦ˆ 1", "BRONZE 2": "ë¸Œë¡ ì¦ˆ 2", "BRONZE 3": "ë¸Œë¡ ì¦ˆ 3", "BRONZE 4": "ë¸Œë¡ ì¦ˆ 4", "IRON 1": "ì•„ì´ì–¸ 1", "IRON 2": "ì•„ì´ì–¸ 2", "IRON 3": "ì•„ì´ì–¸ 3", "IRON 4": "ì•„ì´ì–¸ 4", "UNRANKED": "ì–¸ë­í¬" };

let cachedPlayers = [];
let autoSyncInterval = null; 
let idToKorMap = {}; 
let korToIdMap = {}; 
let watchStartTime = null;

async function initChampMap() {
    try {
        const res = await fetch(`https://ddragon.leagueoflegends.com/cdn/16.3.1/data/ko_KR/champion.json`);
        const json = await res.json();
        Object.values(json.data).forEach(c => {
            idToKorMap[c.id] = c.name; idToKorMap[c.key] = c.name; korToIdMap[c.name] = c.id;   
        });
    } catch (e) { console.error(e); }
}

function getChampName(val) { return (!val || val === 'None') ? '' : (idToKorMap[val] || val); }
function getChampId(val) { return !val ? 'None' : (korToIdMap[val] || val); }

function resetMemberRecord(btn) {
    if(!confirm("ì´ í”Œë ˆì´ì–´ì˜ í‹°ì–´ì™€ ì „ì  ì •ë³´ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
    const card = btn.closest('.member-card');
    const tSelect = card.querySelector('.tier-select');
    tSelect.value = "UNRANKED";
    tSelect.disabled = true;
    tSelect.style.opacity = "0.4";
    const lInput = card.querySelector('.lp-input');
    lInput.value = "";
    lInput.disabled = true;
    lInput.style.opacity = "0.4";
    card.querySelector('.tier-override').checked = false;
    card.querySelector('.lp-override').checked = false;
    card.querySelector('.win-val').value = 0;
    card.querySelector('.lose-val').value = 0;
    card.querySelectorAll('.history-item').forEach(item => {
        item.querySelector('.champ-input').value = "";
        const tBtn = item.querySelector('.btn-toggle');
        tBtn.innerText = 'ğŸ•’ ì§„í–‰';
        tBtn.className = 'btn-toggle ing';
    });
}

function resetAllRecords() {
    if(!confirm("ëª¨ë“  ì •ë³´ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    document.querySelectorAll('.member-card').forEach(card => {
        card.querySelector('.nick-disp').value = "";
        card.querySelector('.nick-riot').value = "";
        resetMemberRecord(card.querySelector('.btn-reset-member'));
    });
}

async function toggleWatch() {
    const btn = document.getElementById('watchBtn');
    if (autoSyncInterval) {
        clearInterval(autoSyncInterval); autoSyncInterval = null;
        watchStartTime = null;
        btn.innerText = "â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘";
    } else {
        watchStartTime = new Date().getTime();
        btn.innerText = "â¹ï¸ ê°ì‹œ ì¤‘";
        await syncWithRiot();
        autoSyncInterval = setInterval(syncWithRiot, 45000); 
    }
}

async function syncWithRiot() { 
    try { 
        await fetch(`/api/sync?t=${Date.now()}`); 
        const { data: pData } = await sb.from('players').select('*').order('created_at', { ascending: true });
        if (pData) mergeRebuild(pData); 
    } catch (e) { console.error(e); } 
}

function findEngTierKey(tierStr) {
    if (!tierStr || tierStr.includes("ì–¸ë­í¬")) return "UNRANKED";
    let cleanTier = tierStr.replace(/\d+LP/gi, '').trim().toUpperCase();
    if (cleanTier.includes("CHALLENGER")) return "CHALLENGER";
    if (cleanTier.includes("GRANDMASTER")) return "GRANDMASTER";
    if (cleanTier.includes("MASTER")) return "MASTER";
    const tierList = ["DIAMOND","EMERALD","PLATINUM","GOLD","SILVER","BRONZE","IRON"];
    let found = tierList.find(t => cleanTier.includes(t)) || "UNRANKED";
    if(found === "UNRANKED") return "UNRANKED";
    let step = cleanTier.match(/[1-4]/) ? cleanTier.match(/[1-4]/)[0] : "4";
    return `${found} ${step}`;
}
    
function mergeRebuild(dbData) {
    const cards = document.querySelectorAll('.member-card');
    cards.forEach(card => {
        const uuid = card.dataset.uuid;
        const dbP = dbData.find(p => String(p.id) === String(uuid));
        if (!dbP) return;

        // í‹°ì–´ ë™ê¸°í™” (ìˆ˜ì • ì²´í¬ ì•ˆí–ˆì„ ë•Œë§Œ)
        if (!card.querySelector('.tier-override').checked) {
            const engKey = findEngTierKey(dbP.tier);
            card.querySelector('.tier-select').value = engKey;
            card.querySelector('.lp-input').value = dbP.tier?.match(/(\d+)LP/)?.[1] || "";
        }

        // ì „ì  ë™ê¸°í™” ë° ìˆ«ì ì¬ê³„ì‚° (ì¤‘ë³µ í•©ì‚° ë°©ì§€ í•µì‹¬)
        const items = card.querySelectorAll('.history-item');
        const dbLastUpdate = dbP.updated_at ? new Date(dbP.updated_at).getTime() : 0;
        
        items.forEach((item, idx) => {
            const btn = item.querySelector('.btn-toggle');
            if (btn.classList.contains('ing') && watchStartTime && dbLastUpdate > watchStartTime) {
                const res = dbP.recent?.[idx];
                if (res === 'win') { btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; btn.className = 'btn-toggle win'; }
                else if (res === 'lose' || res === 'leaver_loss') { btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; btn.className = 'btn-toggle lose'; }
                const dbChamp = dbP.champions?.[idx];
                if (dbChamp && dbChamp !== 'None') item.querySelector('.champ-input').value = getChampName(dbChamp);
            }
        });

        // ìƒë‹¨ ìŠ¹/íŒ¨ ìˆ«ì ì¹¸ì€ ë¬´ì¡°ê±´ í˜„ì¬ í™”ë©´ì˜ ë²„íŠ¼ ìƒíƒœë¥¼ ì„¸ì–´ì„œ ì—…ë°ì´íŠ¸ (DBê°’ ë¬´ì‹œ)
        let curWins = 0, curLosses = 0;
        card.querySelectorAll('.btn-toggle').forEach(b => {
            if(b.classList.contains('win')) curWins++;
            if(b.classList.contains('lose')) curLosses++;
        });
        card.querySelector('.win-val').value = curWins;
        card.querySelector('.lose-val').value = curLosses;
    });
}

function updateTeamNames() {
    document.getElementById('redTitle').innerText = document.getElementById('redNameInput').value || 'ë ˆë“œ íŒ€';
    document.getElementById('blueTitle').innerText = document.getElementById('blueNameInput').value || 'ë¸”ë£¨ íŒ€';
}

function toggleResult(btn) {
    if (btn.innerText.includes('ìŠ¹ë¦¬')) { btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; btn.className = 'btn-toggle lose'; }
    else if (btn.innerText.includes('íŒ¨ë°°')) { btn.innerText = 'ğŸ•’ ì§„í–‰'; btn.className = 'btn-toggle ing'; }
    else { btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; btn.className = 'btn-toggle win'; }
    
    // ìˆ˜ë™ ë³€ê²½ ì‹œì—ë„ ìŠ¹íŒ¨ ìˆ«ì ì¦‰ì‹œ ê°±ì‹ 
    const card = btn.closest('.member-card');
    let w = 0, l = 0;
    card.querySelectorAll('.btn-toggle').forEach(b => {
        if(b.classList.contains('win')) w++;
        if(b.classList.contains('lose')) l++;
    });
    card.querySelector('.win-val').value = w;
    card.querySelector('.lose-val').value = l;
}

function createMemberCard(team, data = null) {
    const card = document.createElement('div');
    card.className = 'member-card'; card.dataset.team = team; card.dataset.uuid = data?.id || ""; 
    let historyHTML = '';
    for(let i=0; i<10; i++) {
        const res = data?.recent?.[i] || 'ing';
        const resText = res === 'win' ? 'ğŸ˜ ìŠ¹ë¦¬' : (res === 'lose' ? 'ğŸ˜¡ íŒ¨ë°°' : 'ğŸ•’ ì§„í–‰');
        historyHTML += `<div class="history-item"><span>${i+1}íŒ</span><input type="text" class="champ-input" value="${getChampName(data?.champions?.[i])}"><button class="btn-toggle ${res === 'win'?'win':res==='lose'?'lose':'ing'}" onclick="toggleResult(this)">${resText}</button></div>`;
    }
    const engKey = findEngTierKey(data?.tier);
    const lpVal = data?.tier?.match(/(\d+)LP/)?.[1] || "";
    const tierOptions = Object.entries(TIER_MAP).map(([e, k]) => `<option value="${e}" ${engKey===e?'selected':''}>${k}</option>`).join('');

    card.innerHTML = `<div class="name-row">
        <div class="input-group"><label>ìŠ¤íŠ¸ë¦¬ë¨¸</label><input class="nick-disp" value="${data?.name||''}"></div>
        <div class="input-group" style="flex:2;"><label>ë¡¤ ë‹‰ë„¤ì„</label><input class="nick-riot" value="${data?.riot_id||''}"></div>
        <div class="input-group"><label style="color:var(--gold);"><input type="checkbox" class="tier-override" ${data?.manual_tier?'checked':''} onchange="toggleManual(this, '.tier-select')"> ìˆ˜ì •</label>
            <select class="tier-select" ${data?.manual_tier?'':'disabled'} style="opacity:${data?.manual_tier?'1':'0.4'};">${tierOptions}</select></div>
        <div class="input-group"><label style="color:var(--gold);"><input type="checkbox" class="lp-override" ${data?.manual_tier?'checked':''} onchange="toggleManual(this, '.lp-input')"> ìˆ˜ì •</label>
            <input class="lp-input" value="${lpVal}" ${data?.manual_tier?'':'disabled'} style="opacity:${data?.manual_tier?'1':'0.4'};"></div>
        <div class="score-input-wrap"><label style="color:var(--gold);">ìŠ¹</label><input class="score-input win-val" value="${data?.wins||0}"></div>
        <div class="score-input-wrap"><label style="color:var(--red);">íŒ¨</label><input class="score-input lose-val" value="${data?.losses||0}"></div>
        <div class="reset-wrap"><button class="btn-reset-member" onclick="resetMemberRecord(this)">ğŸ§¹</button></div>
    </div><div class="history-editor">${historyHTML}</div>`;
    return card;
}

function toggleManual(chk, sel) {
    const t = chk.closest('.member-card').querySelector(sel);
    t.disabled = !chk.checked; t.style.opacity = chk.checked ? "1" : "0.4";
}

function rebuildWithCache() { rebuild(cachedPlayers); }
function rebuild(dataList = []) {
    const rWrap = document.getElementById('redPlayers'); const bWrap = document.getElementById('bluePlayers'); const cnt = Number(document.getElementById('teamCount').value);
    rWrap.innerHTML = ''; bWrap.innerHTML = '';
    const reds = dataList.filter(p => p.team === 'red'); const blues = dataList.filter(p => p.team === 'blue');
    for(let i=0; i<cnt; i++) { rWrap.appendChild(createMemberCard('red', reds[i]||null)); bWrap.appendChild(createMemberCard('blue', blues[i]||null)); }
}

async function loadData() {
    try {
        const { data: s } = await sb.from('settings').select('*').eq('id', 1).single();
        if(s) { document.getElementById('redNameInput').value = s.red_team_name; document.getElementById('blueNameInput').value = s.blue_team_name; document.getElementById('teamCount').value = s.member_count; updateTeamNames(); }
        const { data: p } = await sb.from('players').select('*').order('created_at', { ascending: true });
        cachedPlayers = p || []; rebuild(p);
    } catch (e) { console.error(e); }
}

async function applyToSupabase() {
    const btn = document.querySelector('.btn-apply');
    btn.innerText = "â³ ë°˜ì˜ ì¤‘..."; btn.disabled = true;
    const updates = [];
    document.querySelectorAll('.member-card').forEach(card => {
        const uuid = card.dataset.uuid; if(!uuid) return;
        let recent = [], champs = [];
        card.querySelectorAll('.history-item').forEach(item => {
            const b = item.querySelector('.btn-toggle');
            recent.push(b.innerText.includes('ìŠ¹ë¦¬') ? 'win' : (b.innerText.includes('íŒ¨ë°°') ? 'lose' : 'ing'));
            champs.push(getChampId(item.querySelector('.champ-input').value.trim()));
        });
        const isMan = card.querySelector('.tier-override').checked;
        const ts = card.querySelector('.tier-select');
        const lp = card.querySelector('.lp-input');
        const tierStr = isMan ? (lp.value ? `${TIER_MAP[ts.value]} - ${lp.value}LP` : TIER_MAP[ts.value]) : "ì–¸ë­í¬";
        updates.push({
            "id": uuid, "name": card.querySelector('.nick-disp').value.trim(), "team": card.dataset.team, "riot_id": card.querySelector('.nick-riot').value.trim(),
            "tier": tierStr, "manual_tier": isMan, "wins": Number(card.querySelector('.win-val').value), "losses": Number(card.querySelector('.lose-val').value),
            "recent": recent, "champions": champs, "trigger_cutscene": false
        });
    });
    try {
        await sb.from('settings').upsert({ id: 1, red_team_name: document.getElementById('redNameInput').value, blue_team_name: document.getElementById('blueNameInput').value, member_count: Number(document.getElementById('teamCount').value) });
        if(updates.length > 0) await sb.from('players').upsert(updates);
        alert('âœ… ë°˜ì˜ ì™„ë£Œ!'); await loadData();
    } catch (e) { console.error(e); } finally { btn.innerText = "ì†¡ì¶œ í™”ë©´ ë°˜ì˜"; btn.disabled = false; }
}

async function start() { await initChampMap(); await loadData(); }
start();
</script>
</body>
</html>












