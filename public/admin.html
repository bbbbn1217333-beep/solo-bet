<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° - ê´€ë¦¬ì íŒ¨ë„</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    :root { --bg: #0f1218; --card: #1e232b; --gold: #ffd369; --red: #ff5c5c; --blue: #4db8ff; --border: #383e4a; }
    body { background: var(--bg); color: #fff; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .team-container { display: flex; gap: 20px; margin-bottom: 80px; }
    .team-section { flex: 1; background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid var(--border); }
    .team-title { font-size: 20px; font-weight: 800; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
    .red .team-title { color: var(--red); }
    .blue .team-title { color: var(--blue); }
    
    .member-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .name-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
    .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
    .input-group label { font-size: 12px; color: #aaa; }
    input, select { background: #000; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; font-size: 13px; }
    
    .history-editor { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
    .history-item { display: flex; flex-direction: column; gap: 3px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
    .history-item span { font-size: 10px; color: #888; text-align: center; }
    .btn-toggle { border: none; padding: 4px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 800; }
    .btn-toggle.win { background: var(--gold); color: #000; }
    .btn-toggle.lose { background: var(--red); color: #fff; }
    .btn-toggle.ing { background: #444; color: #ccc; }

    .controls { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 15px 30px; display: flex; justify-content: flex-end; gap: 15px; border-top: 2px solid var(--gold); z-index: 1000; }
    button.main-btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; }
    .btn-apply { background: var(--gold); color: #000; }
    .btn-apply:hover { transform: scale(1.05); filter: brightness(1.1); }
    
    .score-input-wrap { display: flex; flex-direction: column; gap: 2px; width: 45px; }
    .score-input { text-align: center; font-weight: 800; }
</style>
</head>
<body>

<div class="header">
    <div style="display:flex; gap:20px;">
        <div class="input-group">
            <label>ì¢…ë£Œ ì¼ì‹œ</label>
            <input type="datetime-local" id="endDateTime">
        </div>
        <div class="input-group">
            <label>íŒ€ë³„ ì¸ì›</label>
            <select id="teamCount" onchange="resetTeams()">
                <option value="1">1ëª…</option><option value="2">2ëª…</option><option value="3">3ëª…</option><option value="4" selected>4ëª…</option><option value="5">5ëª…</option>
            </select>
        </div>
    </div>
    <div style="display:flex; gap:15px;">
        <input type="text" id="redNameInput" placeholder="ë ˆë“œíŒ€ ëª…ì¹­" value="RED TEAM" style="color:var(--red); border-color:var(--red);">
        <input type="text" id="blueNameInput" placeholder="ë¸”ë£¨íŒ€ ëª…ì¹­" value="BLUE TEAM" style="color:var(--blue); border-color:var(--blue);">
    </div>
</div>

<div class="team-container">
    <div class="team-section red" id="redTeam">
        <div class="team-title">RED TEAM</div>
        <div class="member-list"></div>
    </div>
    <div class="team-section blue" id="blueTeam">
        <div class="team-title">BLUE TEAM</div>
        <div class="member-list"></div>
    </div>
</div>

<div class="controls">
    <button class="main-btn" style="background:#444; color:#fff;" onclick="loadFromSupabase()">ìƒˆë¡œê³ ì¹¨(DBë¶ˆëŸ¬ì˜¤ê¸°)</button>
    <button class="main-btn btn-apply" onclick="applyToSupabase()">â˜… ì†¡ì¶œ í™”ë©´ ë°˜ì˜ â˜…</button>
</div>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = {
    "CHALLENGER": "ì±Œë¦°ì €", "GRANDMASTER": "ê·¸ëœë“œë§ˆìŠ¤í„°", "MASTER": "ë§ˆìŠ¤í„°",
    "DIAMOND": "ë‹¤ì´ì•„ëª¬ë“œ", "EMERALD": "ì—ë©”ë„ë“œ", "PLATINUM": "í”Œë˜í‹°ë„˜",
    "GOLD": "ê³¨ë“œ", "SILVER": "ì‹¤ë²„", "BRONZE": "ë¸Œë¡ ì¦ˆ", "IRON": "ì•„ì´ì–¸", "UNRANKED": "ì–¸ë­í¬"
};

let cachedPlayers = [];

// [1] ë©¤ë²„ ì¹´ë“œ ìƒì„±
function createMemberCard(team, data = null) {
    const card = document.createElement('div');
    card.className = 'member-card';
    card.dataset.team = team;
    card.dataset.puuid = data?.puuid || ""; 
    card.dataset.lastMatchId = data?.last_match_id || ""; 
    // ì¤‘ìš”: ê¸°ì¡´ í‹°ì–´ë¥¼ ì €ì¥í•´ë‘  (ë‚˜ì¤‘ì— ì €ì¥ ì‹œ í™œìš©)
    card.dataset.existingTier = data?.tier || "ì–¸ë­í¬";

    let historyHTML = '';
    for(let i=0; i<10; i++) {
        const champ = (data?.champions?.[i] === 'None' || !data?.champions?.[i]) ? '' : data.champions[i];
        const res = data?.recent?.[i] || 'ing';
        const resText = res === 'win' ? 'ğŸ˜ ìŠ¹ë¦¬' : (res === 'lose' ? 'ğŸ˜¡ íŒ¨ë°°' : 'ğŸ•’ ì§„í–‰');
        const resClass = res === 'win' ? 'win' : (res === 'lose' ? 'lose' : 'ing');
        historyHTML += `<div class="history-item"><span>${i+1}íŒ</span><input type="text" class="champ-input" placeholder="ì±”í”¼ì–¸" value="${champ}"><button class="btn-toggle ${resClass}" onclick="toggleResult(this)">${resText}</button></div>`;
    }

    // í‹°ì–´ íŒŒì‹±í•´ì„œ ì„ íƒë°•ìŠ¤ ì´ˆê¸°ê°’ ì¡ê¸°
    let currentTierEng = "UNRANKED";
    let currentLP = "";
    if (data?.tier && data.tier !== "ì–¸ë­í¬") {
        const mainTier = data.tier.split(' ')[0];
        currentTierEng = Object.keys(TIER_MAP).find(key => TIER_MAP[key] === mainTier) || "UNRANKED";
        const lpMatch = data.tier.match(/(\d+)LP/);
        currentLP = lpMatch ? lpMatch[1] : "";
    }

    const tierOptions = Object.entries(TIER_MAP).map(([eng, kor]) => `<option value="${eng}" ${currentTierEng === eng ? 'selected' : ''}>${kor}</option>`).join('');

    card.innerHTML = `
        <div class="name-row">
            <div class="input-group"><label>ìŠ¤íŠ¸ë¦¬ë¨¸ëª…</label><input class="nick-disp" value="${data?.name || ''}"></div>
            <div class="input-group"><label>ë¡¤ ë‹‰ë„¤ì„ (ì¡°íšŒìš©)</label><input class="nick-riot" placeholder="ë‹‰ë„¤ì„#íƒœê·¸" value="${data?.riot_id || ''}" onblur="fetchRiotData(this)"></div>
            <div class="input-group">
                <label style="color:var(--gold);"><input type="checkbox" class="tier-override" ${data?.manual_tier ? 'checked' : ''} onchange="toggleLock(this)"> ìˆ˜ë™ìˆ˜ì •</label>
                <select class="tier-select" ${data?.manual_tier ? '' : 'disabled'}>${tierOptions}</select>
            </div>
            <div class="input-group" style="flex:0.5;">
                <label>LP</label>
                <input class="lp-input" value="${currentLP}" ${data?.manual_tier ? '' : 'disabled'}>
            </div>
            <div class="score-input-wrap"><label>ìŠ¹</label><input class="score-input win-val" value="${data?.wins ?? ''}"></div>
            <div class="score-input-wrap"><label>íŒ¨</label><input class="score-input lose-val" value="${data?.losses ?? ''}"></div>
        </div>
        <div class="history-editor">${historyHTML}</div>
        <div class="status-msg" style="font-size:11px; margin-top:5px; color:#888;"></div>`;
    return card;
}

function toggleResult(btn) {
    if(btn.classList.contains('ing')) { btn.className = 'btn-toggle win'; btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; }
    else if(btn.classList.contains('win')) { btn.className = 'btn-toggle lose'; btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; }
    else { btn.className = 'btn-toggle ing'; btn.innerText = 'ğŸ•’ ì§„í–‰'; }
}

function toggleLock(cb) {
    const card = cb.closest('.member-card');
    card.querySelector('.tier-select').disabled = !cb.checked;
    card.querySelector('.lp-input').disabled = !cb.checked;
}

// [2] ë¼ì´ì—‡ ë°ì´í„° ì¡°íšŒ (í•µì‹¬ ìˆ˜ì •!)
async function fetchRiotData(input) {
    const val = input.value.trim();
    if(!val.includes('#')) return;
    const card = input.closest('.member-card');
    const msg = card.querySelector('.status-msg');
    msg.innerText = "â³ ì¡°íšŒ ì¤‘...";

    try {
        const [name, tag] = val.split('#');
        const res = await fetch(`https://solrank-api-production.up.railway.app/api/summoner?name=${encodeURIComponent(name)}&tag=${encodeURIComponent(tag)}`);
        const d = await res.json();
        
        if(d.tier) {
            msg.style.color = "var(--blue)";
            msg.innerText = `âœ… ì¡°íšŒ ì™„ë£Œ: ${d.tier} ${d.rank} ${d.leaguePoints}LP`;
            
            // ë°ì´í„°ì…‹ ì—…ë°ì´íŠ¸
            const tierKor = TIER_MAP[d.tier] || d.tier;
            const finalStr = `${tierKor} ${d.rank} - ${d.leaguePoints}LP`;
            card.dataset.existingTier = finalStr;
            card.dataset.puuid = d.puuid;

            // í™”ë©´ ì„ íƒë°•ìŠ¤ë„ ë™ê¸°í™” (ë‹¨, ìˆ˜ë™ ëª¨ë“œê°€ ì•„ë‹ ë•Œ)
            if(!card.querySelector('.tier-override').checked) {
                card.querySelector('.tier-select').value = d.tier;
                card.querySelector('.lp-input').value = d.leaguePoints;
            }
        } else {
            msg.style.color = "var(--red)";
            msg.innerText = "âŒ ì†Œí™˜ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ";
        }
    } catch(e) {
        msg.innerText = "âŒ ì„œë²„ ì—ëŸ¬";
    }
}

// [3] ìŠˆíŒŒë² ì´ìŠ¤ ë°˜ì˜ (ì €ì¥ ë¡œì§)
async function applyToSupabase() {
    const playersUpdateList = [];
    let cutsceneAssigned = false;

    document.querySelectorAll('.member-card').forEach(card => {
        const name = card.querySelector('.nick-disp').value.trim();
        if(!name) return;

        const recent = [], champs = [];
        card.querySelectorAll('.history-item').forEach(item => {
            recent.push(item.querySelector('.btn-toggle').classList.contains('win') ? 'win' : (item.querySelector('.btn-toggle').classList.contains('lose') ? 'lose' : 'ing'));
            champs.push(item.querySelector('.champ-input').value.trim() || 'None');
        });

        // í‹°ì–´ ê²°ì • ë¡œì§
        const isManual = card.querySelector('.tier-override').checked;
        let finalTier = "";
        
        if(isManual) {
            const selTier = card.querySelector('.tier-select').value;
            const lp = card.querySelector('.lp-input').value.trim();
            if(selTier === "UNRANKED") finalTier = "ì–¸ë­í¬";
            else finalTier = lp ? `${TIER_MAP[selTier]} - ${lp}LP` : TIER_MAP[selTier];
        } else {
            // ì¡°íšŒëœ ê°’ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì“°ê³ , ì—†ìœ¼ë©´ "ì–¸ë­í¬"
            finalTier = card.dataset.existingTier || "ì–¸ë­í¬";
        }

        let trigger = false;
        if(!cutsceneAssigned) {
            const last = recent.filter(r => r === 'win' || r === 'lose').pop();
            const prevPlayer = cachedPlayers.find(p => p.name === name);
            const prevLast = prevPlayer?.recent?.filter(r => r === 'win' || r === 'lose').pop();
            if(last && last !== prevLast) { trigger = true; cutsceneAssigned = true; }
        }

        playersUpdateList.push({
            name, team: card.dataset.team, riot_id: card.querySelector('.nick-riot').value.trim(),
            puuid: card.dataset.puuid, tier: finalTier, manual_tier: isManual,
            wins: card.querySelector('.win-val').value !== '' ? Number(card.querySelector('.win-val').value) : recent.filter(r=>r==='win').length,
            losses: card.querySelector('.lose-val').value !== '' ? Number(card.querySelector('.lose-val').value) : recent.filter(r=>r==='lose').length,
            recent, champions: champs, trigger_cutscene: trigger
        });
    });

    try {
        await sb.from('settings').upsert({ 
            id: 1, 
            red_team_name: document.getElementById('redNameInput').value, 
            blue_team_name: document.getElementById('blueNameInput').value, 
            member_count: Number(document.getElementById('teamCount').value),
            timer_end_at: document.getElementById('endDateTime').value || null 
        });

        // ì „ì²´ ì‚­ì œ í›„ ì¬ì‚½ì… (UUID ì—ëŸ¬ ë°©ì§€ìš© ì•ˆì „ ì‚­ì œ)
        await sb.from('players').delete().not('name', 'eq', 'NO_MATCH_ANY_NAME');
        await new Promise(r => setTimeout(r, 200));
        await sb.from('players').insert(playersUpdateList);

        alert("âœ… ë°˜ì˜ ì„±ê³µ!");
        cachedPlayers = JSON.parse(JSON.stringify(playersUpdateList));
    } catch(e) {
        alert("âŒ ì˜¤ë¥˜: " + e.message);
    }
}

async function loadFromSupabase() {
    const { data: s } = await sb.from('settings').select('*').eq('id', 1).single();
    if(s) {
        document.getElementById('redNameInput').value = s.red_team_name;
        document.getElementById('blueNameInput').value = s.blue_team_name;
        document.getElementById('teamCount').value = s.member_count;
        if(s.timer_end_at) document.getElementById('endDateTime').value = s.timer_end_at.substring(0,16);
    }
    const { data: p } = await sb.from('players').select('*').order('created_at', {ascending:true});
    cachedPlayers = p || [];
    resetTeams(p);
}

function resetTeams(data = []) {
    const count = Number(document.getElementById('teamCount').value);
    const redList = document.querySelector('.red .member-list');
    const blueList = document.querySelector('.blue .member-list');
    redList.innerHTML = ''; blueList.innerHTML = '';
    
    for(let i=0; i<count; i++) {
        redList.appendChild(createMemberCard('red', data.filter(x => x.team==='red')[i]));
        blueList.appendChild(createMemberCard('blue', data.filter(x => x.team==='blue')[i]));
    }
}

loadFromSupabase();
</script>
</body>
</html>





















