<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ë¼ë„¤ ì†”ë­ ë‚´ê¸° ì‹œíŠ¸ì§€ ê´€ë¦¬ììš©</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@600;800;900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --red: #ff3b3b; --blue: #4db8ff; --gold: #ffd369; --emerald: #2ecc71; 
            --neon-red: 0 0 15px rgba(255, 59, 59, 0.8);
            --neon-blue: 0 0 15px rgba(77, 184, 255, 0.8);
            --neon-gold: 0 0 20px rgba(255, 211, 105, 0.8);
        }
        body { margin:0; background:#0e0e0e; color:#fff; font-family:'Pretendard',sans-serif; padding:15px; padding-bottom: 120px; overflow-x: auto; }
        .wrap { width: 1550px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .admin-header { background:#1a1a1a; padding:25px; border-radius:15px; border: 2px solid var(--gold); box-shadow: var(--neon-gold); }
        .top-controls { display:flex; gap:15px; align-items:flex-end; margin-bottom:20px; flex-wrap: nowrap; }
        .header-group { display:flex; flex-direction:column; gap:8px; }
        .label-red { font-size:15px; font-weight:900; color:var(--red) !important; text-shadow: 0 0 8px rgba(255,59,59,0.5); }
        .label-blue { font-size:15px; font-weight:900; color:var(--blue) !important; text-shadow: 0 0 8px rgba(77,184,255,0.5); }
        .label-gold { font-size:15px; font-weight:900; color:var(--gold); text-shadow: 0 0 8px rgba(255,211,105,0.5); }
        .menu-desc { font-size:14px; color:#ccc; line-height:1.8; background:#111; padding:20px; border-radius:10px; border: 2px solid var(--gold); box-shadow: inset 0 0 15px rgba(255,211,105,0.1); margin-top: 10px; font-weight: 800; }
        .menu-desc strong { color: var(--gold); font-size: 18px; text-shadow: 0 0 10px var(--gold); display: block; margin-bottom: 5px; font-weight: 900; }
        .neon-point { color: var(--gold); text-shadow: 0 0 10px var(--gold); font-weight: 900; }
        .top-controls input[type="text"], .top-controls input[type="number"] {
            height: 50px; padding:12px; background:#000; border-radius:8px; font-size:16px; font-weight:900;
            outline:none; border: 2px solid var(--gold); color: #fff; box-shadow: var(--neon-gold); box-sizing: border-box;
        }
        .timer-input-wrap {
            display: flex; align-items: center; background: #000; padding: 0 15px;
            border-radius: 8px; border: 2px solid var(--gold); height: 50px; box-sizing: border-box;
            box-shadow: none !important;
        }
        #endDateTime {
            background: transparent; border: none; color: #fff; font-family: 'Pretendard';
            font-weight: 900; font-size: 16px; outline: none; color-scheme: dark;
            box-shadow: none !important;
        }
        #redNameInput, #blueNameInput { width: 140px; }
        #teamCount { width:65px; text-align: center; }
        .btn-load-data, .btn-reset-all {
            height: 50px; padding:0 20px; border-radius:8px; cursor:pointer; font-weight:900;
            font-size: 15px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;
        }
        .btn-load-data { background:#000; color:var(--emerald); border:2px solid var(--emerald); box-shadow: 0 0 15px rgba(46,204,113,0.5); flex: 1; }
        #watchBtn { flex: 1.5; transition: all 0.3s; }
        .btn-reset-all { background:#000; color:var(--red); border:2px solid var(--red); box-shadow: var(--neon-red); flex: 0.8; }
        .teams-container { display:flex; gap:25px; width: 100%; }
        .team-box { flex:1; background:#1a1a1a; padding:20px; border-radius:15px; border-top: 5px solid; min-width: 740px; }
        .team-box.red { border-color: var(--red); box-shadow: 0 -5px 15px rgba(255,59,59,0.3); }
        .team-box.blue { border-color: var(--blue); box-shadow: 0 -5px 15px rgba(77,184,255,0.3); }
        .member-list { display:flex; flex-direction:column; gap:20px; max-height:850px; overflow-y:auto; padding: 10px; }
        .member-card { background:#151515; border-radius:12px; padding:20px; border: 2px solid; margin-bottom: 5px; position: relative; }
        .red .member-card { border-color: var(--red); box-shadow: var(--neon-red); }
        .blue .member-card { border-color: var(--blue); box-shadow: var(--neon-blue); }
        .name-row { display:flex; gap:8px; margin-bottom:15px; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; align-items: center; position: relative; }
        .input-group label { font-size:12px; font-weight:900; color:#fff; margin-bottom: 6px; white-space: nowrap; height: 14px; display: flex; align-items: center; }
        .nick-disp, .nick-riot, .tier-select, .lp-input {
            height: 44px !important; background:#000; border-radius:6px; font-size:14px; font-weight:900;
            color:#fff !important; outline:none; text-align: center; border: 2px solid;
            box-sizing: border-box !important; padding: 0 10px; font-family: 'Pretendard', sans-serif !important;
        }
        .red .nick-disp, .red .nick-riot { border-color: var(--red); }
        .blue .nick-disp, .blue .nick-riot { border-color: var(--blue); }
        .nick-disp { width: 95px; flex: none; }
        .nick-riot { width: 220px; flex: none; }
        .tier-select {
            width: 140px; border-color: var(--tier-color, var(--gold)) !important;
            color: var(--tier-color, var(--gold)) !important; cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23ffd369' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
        }
        .lp-input { width: 75px; border-color: var(--tier-color, var(--gold)) !important; color: var(--tier-color, var(--gold)) !important; }
        .score-input { width: 45px; height: 35px; text-align:center; border-radius:6px; font-size:16px; font-weight: 900; outline: none; background:#000; }
        .win-val { border: 2px solid var(--gold); color: var(--gold); box-shadow: var(--neon-gold); }
        .lose-val { border: 2px solid var(--red); color: var(--red); box-shadow: var(--neon-red); }
        .btn-reset-member { position: absolute; top: -5px; right: 350px; height: 20px; width: 30px; background: #222; border: 1px solid #444; color: #777; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .btn-reset-member:hover { border-color: var(--red); color: var(--red); background: #000; box-shadow: var(--neon-red); }
        .history-editor { display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; background:#0c0c0c; padding:15px; border-radius:10px; }
        .history-item { display:flex; flex-direction:column; gap:6px; align-items:center; padding: 10px 5px; border-radius: 8px; border: 2px solid; }
        .red .history-item { border-color: var(--red); }
        .blue .history-item { border-color: var(--blue); }
        .history-item span { color: var(--gold); font-weight: 900; font-size: 12px; }
        .champ-input { width:92%; background:#000; border: 2px solid var(--gold); color:#fff; text-align:center; padding:8px 0; border-radius:5px; font-size:12px; font-weight: 800; outline: none; }
        .btn-toggle { width:100%; padding:8px 0; font-size:11px; font-weight:900; border:none; border-radius:4px; cursor:pointer; }
        .btn-toggle.win { background: var(--gold); color: #000; }
        .btn-toggle.lose { background: var(--red); color: #fff; }
        .btn-toggle.ing { background: var(--emerald); color: #fff; }
        .btn-apply { position: fixed; bottom: 30px; right: 30px; z-index: 1000; width: 280px; height: 70px; font-size:24px; font-weight:900; background: var(--red); color:#fff; border:none; border-radius:15px; cursor:pointer; box-shadow: 0 0 30px rgba(255,59,59,0.7); }
        #debugLog { position:fixed; bottom:120px; left:15px; background:rgba(0,0,0,0.9); color:#0f0; font-size:11px; font-family:monospace; padding:10px; border-radius:8px; border:1px solid #333; max-width:450px; max-height:220px; overflow-y:auto; z-index:999; display:none; }
    </style>
</head>
<body>

<div class="wrap">
    <div class="admin-header">
        <div class="top-controls">
            <div class="header-group"><label class="label-red">ğŸš© ë ˆë“œ íŒ€ ëª…ì¹­</label><input id="redNameInput" type="text" oninput="updateTeamNames()" placeholder="ë ˆë“œ íŒ€"></div>
            <div class="header-group"><label class="label-blue">ğŸš© ë¸”ë£¨ íŒ€ ëª…ì¹­</label><input id="blueNameInput" type="text" oninput="updateTeamNames()" placeholder="ë¸”ë£¨ íŒ€"></div>
            <div class="header-group">
                <label class="label-gold">â° ëª©í‘œ ì¢…ë£Œ ì‹œê°„</label>
                <div class="timer-input-wrap"><input id="endDateTime" type="datetime-local"></div>
            </div>
            <div class="header-group"><label class="label-gold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì¸ì›</label><input id="teamCount" type="number" min="1" max="33" value="5" onchange="rebuildWithCache()"></div>
            <button id="watchBtn" class="btn-load-data" onclick="toggleWatch()" style="color:var(--gold);border-color:var(--gold);box-shadow:var(--neon-gold);">â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘</button>
            <button class="btn-load-data" onclick="loadData()">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-reset-all" onclick="resetAllRecords()">ğŸ§¹ ì „ì²´ ì´ˆê¸°í™”</button>
            <button class="btn-load-data" onclick="toggleDebug()" style="color:#888;border-color:#444;box-shadow:none;flex:0.5;font-size:12px;">ğŸ” ë¡œê·¸</button>
        </div>
        <div class="menu-desc">
            <strong>ğŸ’¡ ì „ì  ê¸°ë¡ ë¡œì§ ì•ˆë‚´</strong>
            â€¢ <span class="neon-point">ìë™ ê°ì‹œ:</span> ê°ì‹œ ì‹œì‘ ì´í›„ ì™„ë£Œëœ ê²Œì„ë§Œ ê¸°ë¡ë©ë‹ˆë‹¤. ê°ì‹œ ì‹œì‘ ì „ ê²Œì„ì€ ë¬´ì‹œë©ë‹ˆë‹¤.<br>
            â€¢ <span class="neon-point">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°:</span> DBì— ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ í™”ë©´ì— ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.<br>
            â€¢ <span class="neon-point">ìˆ˜ë™ ìˆ˜ì •:</span> ìˆ˜ì • ì²´í¬ë°•ìŠ¤ ì²´í¬ ì‹œ API ë°ì´í„°ë¥¼ ë¬´ì‹œí•˜ê³  ì…ë ¥í•œ í‹°ì–´/LPê°€ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.
        </div>
    </div>
    <div class="teams-container">
        <div class="team-box red">
            <h2 id="redTitle" style="color:var(--red);font-weight:900;font-size:32px;margin-bottom:20px;">ë ˆë“œ íŒ€</h2>
            <div id="redPlayers" class="member-list"></div>
        </div>
        <div class="team-box blue">
            <h2 id="blueTitle" style="color:var(--blue);font-weight:900;font-size:32px;margin-bottom:20px;">ë¸”ë£¨ íŒ€</h2>
            <div id="bluePlayers" class="member-list"></div>
        </div>
    </div>
</div>
<button class="btn-apply" onclick="applyToSupabase()">ì†¡ì¶œ í™”ë©´ ë°˜ì˜</button>
<div id="debugLog"></div>

<script>
const SUPABASE_URL = "https://hsvknfmnsehwytnvaiwr.supabase.co";
const SUPABASE_KEY = "sb_publishable_l2wj1IeGSfcxgKVjJ28n0w_WK9iHm-j";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TIER_MAP = {
    "CHALLENGER":"ì±Œë¦°ì €","GRANDMASTER":"ê·¸ëœë“œë§ˆìŠ¤í„°","MASTER":"ë§ˆìŠ¤í„°",
    "DIAMOND 1":"ë‹¤ì´ì•„ëª¬ë“œ 1","DIAMOND 2":"ë‹¤ì´ì•„ëª¬ë“œ 2","DIAMOND 3":"ë‹¤ì´ì•„ëª¬ë“œ 3","DIAMOND 4":"ë‹¤ì´ì•„ëª¬ë“œ 4",
    "EMERALD 1":"ì—ë©”ë„ë“œ 1","EMERALD 2":"ì—ë©”ë„ë“œ 2","EMERALD 3":"ì—ë©”ë„ë“œ 3","EMERALD 4":"ì—ë©”ë„ë“œ 4",
    "PLATINUM 1":"í”Œë˜í‹°ë„˜ 1","PLATINUM 2":"í”Œë˜í‹°ë„˜ 2","PLATINUM 3":"í”Œë˜í‹°ë„˜ 3","PLATINUM 4":"í”Œë˜í‹°ë„˜ 4",
    "GOLD 1":"ê³¨ë“œ 1","GOLD 2":"ê³¨ë“œ 2","GOLD 3":"ê³¨ë“œ 3","GOLD 4":"ê³¨ë“œ 4",
    "SILVER 1":"ì‹¤ë²„ 1","SILVER 2":"ì‹¤ë²„ 2","SILVER 3":"ì‹¤ë²„ 3","SILVER 4":"ì‹¤ë²„ 4",
    "BRONZE 1":"ë¸Œë¡ ì¦ˆ 1","BRONZE 2":"ë¸Œë¡ ì¦ˆ 2","BRONZE 3":"ë¸Œë¡ ì¦ˆ 3","BRONZE 4":"ë¸Œë¡ ì¦ˆ 4",
    "IRON 1":"ì•„ì´ì–¸ 1","IRON 2":"ì•„ì´ì–¸ 2","IRON 3":"ì•„ì´ì–¸ 3","IRON 4":"ì•„ì´ì–¸ 4",
    "UNRANKED":"ì–¸ë­í¬"
};
const TIER_COLORS = {
    "CHALLENGER":"#f7d61b","GRANDMASTER":"#ff4e50","MASTER":"#df73ff",
    "DIAMOND":"#57d8ff","EMERALD":"#2ecc71","PLATINUM":"#4fffc0",
    "GOLD":"#ffd369","SILVER":"#c0c0c0","BRONZE":"#cd7f32","IRON":"#a19d94","UNRANKED":"#ffffff"
};

let cachedPlayers = [], idToKorMap = {}, korToIdMap = {}, engToIdMap = {};
let isWatching = false, watchInterval = null;
let watchSnapshot = {};

function log(msg) {
    const el = document.getElementById('debugLog');
    const t = new Date().toLocaleTimeString('ko-KR');
    el.innerHTML += `<div>[${t}] ${msg}</div>`;
    el.scrollTop = el.scrollHeight;
    console.log(`[${t}] ${msg}`);
}
function toggleDebug() {
    const el = document.getElementById('debugLog');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function padArray(arr, len, fill) {
    const base = Array.isArray(arr) ? [...arr] : [];
    while (base.length < len) base.push(fill);
    return base;
}

function findEngTierKey(tierStr) {
    if (!tierStr) return "UNRANKED";
    const t = tierStr.trim();
    if (!t || t === "ì–¸ë­í¬" || t.toUpperCase() === "UNRANKED") return "UNRANKED";
    const upper = t.toUpperCase();
    if (upper.includes("ì±Œë¦°ì €") || upper.includes("CHALLENGER")) return "CHALLENGER";
    if (upper.includes("ê·¸ëœë“œë§ˆìŠ¤í„°") || upper.includes("GRANDMASTER")) return "GRANDMASTER";
    if (upper.includes("ë§ˆìŠ¤í„°") || upper.includes("MASTER")) return "MASTER";
    const tierDefs = [
        { key:"DIAMOND",  kor:["ë‹¤ì´ì•„ëª¬ë“œ","ë‹¤ì´ì•„"], eng:"DIAMOND" },
        { key:"EMERALD",  kor:["ì—ë©”ë„ë“œ"],            eng:"EMERALD" },
        { key:"PLATINUM", kor:["í”Œë˜í‹°ë„˜","í”Œë˜","í”Œë ˆ"], eng:"PLATINUM" },
        { key:"GOLD",     kor:["ê³¨ë“œ"],                eng:"GOLD" },
        { key:"SILVER",   kor:["ì‹¤ë²„"],                eng:"SILVER" },
        { key:"BRONZE",   kor:["ë¸Œë¡ ì¦ˆ"],              eng:"BRONZE" },
        { key:"IRON",     kor:["ì•„ì´ì–¸"],              eng:"IRON" },
    ];
    let foundKey = "";
    for (const td of tierDefs) {
        if ([...td.kor, td.eng].some(kw => upper.includes(kw.toUpperCase()))) { foundKey = td.key; break; }
    }
    if (!foundKey) return "UNRANKED";
    const numMatch = t.match(/[1-4]/);
    if (numMatch) return `${foundKey} ${numMatch[0]}`;
    if (/\bIV\b/.test(upper)) return `${foundKey} 4`;
    if (/\bIII\b/.test(upper)) return `${foundKey} 3`;
    if (/\bII\b/.test(upper)) return `${foundKey} 2`;
    if (/\bI\b/.test(upper)) return `${foundKey} 1`;
    return `${foundKey} 4`;
}

function extractLP(tierStr) {
    if (!tierStr) return "0";
    const m = tierStr.match(/(\d+)\s*LP/i);
    return m ? m[1] : "0";
}

function updateTierUI(el) {
    if (!el) return;
    const key = el.value.split(' ')[0];
    const color = TIER_COLORS[key] || "#ffffff";
    const card = el.closest('.member-card');
    if (!card) return;
    card.style.setProperty('--tier-color', color);
    card.style.setProperty('--tier-shadow', color + '66');
}

async function initChampMap() {
    try {
        const res = await fetch(`https://ddragon.leagueoflegends.com/cdn/16.3.1/data/ko_KR/champion.json`);
        const json = await res.json();
        Object.values(json.data).forEach(c => {
            idToKorMap[c.key] = c.name;
            korToIdMap[c.name] = c.id;
            engToIdMap[c.id.toLowerCase()] = c.name;
        });
        korToIdMap["ìë¥´ë°˜ 4ì„¸"] = "JarvanIV";
        idToKorMap["64"] = "ìë¥´ë°˜ 4ì„¸";
        engToIdMap["jarvaniv"] = "ìë¥´ë°˜ 4ì„¸";
        log(`ì±”í”¼ì–¸ ë§µ ë¡œë“œ: ${Object.keys(idToKorMap).length}ê°œ`);
    } catch (e) { log(`ì±”í”¼ì–¸ ë§µ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`); }
}

async function syncWithRiot() {
    try {
        log("sync í˜¸ì¶œ ì¤‘...");
        const response = await fetch('/api/sync');
        const result = await response.json();
        log(`sync ê²°ê³¼: updated=${result.updated}`);
        if (result.debug) result.debug.forEach(d => log(`  í‹°ì–´ì €ì¥: ${d.id.slice(0,8)}... â†’ ${d.tier} (manual:${d.manual})`));
        if (result.success || result.updated >= 0) {
            const { data: pData } = await sb.from('players').select('*').order('id', { ascending: true });
            if (pData) {
                log(`DB ê°±ì‹  ${pData.length}ëª…`);
                mergeData(pData);
            }
        } else {
            log(`sync ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
    } catch (e) {
        log(`syncWithRiot ì—ëŸ¬: ${e.message}`);
    }
}

function mergeData(dbData) {
    cachedPlayers = dbData;

    document.querySelectorAll('.member-card').forEach((card) => {
        const uuid = card.dataset.uuid;
        const p = dbData.find(d => String(d.id) === String(uuid));
        if (!p) return;

        const safeRecent = padArray(p.recent, 10, 'ing');
        const safeChamps = padArray(p.champions, 10, 'None');

        const tCheck = card.querySelector('.tier-override');
        if (tCheck && !tCheck.checked && p.tier) {
            const sel = card.querySelector('.tier-select');
            const lpInp = card.querySelector('.lp-input');
            const engTier = findEngTierKey(p.tier);
            log(`[${p.name}] í‹°ì–´: "${p.tier}" â†’ "${engTier}"`);
            if (engTier && sel.value !== engTier) { sel.value = engTier; updateTierUI(sel); }
            const newLP = extractLP(p.tier);
            if (lpInp.value !== newLP) lpInp.value = newLP;
        }

        card.querySelectorAll('.history-item').forEach((item, idx) => {
            const btn = item.querySelector('.btn-toggle');
            const cInput = item.querySelector('.champ-input');
            const dbRes = safeRecent[idx];
            const dbChamp = safeChamps[idx];

            if (isWatching) {
                if (dbChamp && dbChamp !== 'None') {
                    const korName = idToKorMap[dbChamp] || engToIdMap[String(dbChamp).toLowerCase()] || dbChamp;
                    if (cInput.value !== korName) {
                        cInput.value = korName;
                        log(`[${p.name}] ${idx+1}íŒ ì±”í”¼ì–¸: ${korName}`);
                    }
                }

                if (dbRes === 'ing') {
                    btn.innerText = 'ğŸ•’ ì§„í–‰'; btn.className = 'btn-toggle ing';
                } else {
                    const snap = watchSnapshot[p.id];
                    const snapRes = snap?.recent?.[idx];
                    if (snapRes !== dbRes) {
                        if (dbRes === 'win') {
                            btn.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; btn.className = 'btn-toggle win';
                            log(`[${p.name}] ${idx+1}íŒ ìŠ¹ë¦¬`);
                        } else if (dbRes === 'lose' || dbRes === 'leaver_loss') {
                            btn.innerText = 'ğŸ˜¡ íŒ¨ë°°'; btn.className = 'btn-toggle lose';
                            log(`[${p.name}] ${idx+1}íŒ íŒ¨ë°°`);
                        }
                        // âœ… ë°˜ì˜ í›„ ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸ â†’ ë‹¤ìŒ syncì—ì„œ ì¤‘ë³µ ë°˜ì˜ ë°©ì§€
                        if (watchSnapshot[p.id]) {
                            watchSnapshot[p.id].recent[idx] = dbRes;
                        }
                    }
                }
            } else {
                if (dbChamp && dbChamp !== 'None' && !cInput.value) {
                    cInput.value = idToKorMap[dbChamp] || engToIdMap[String(dbChamp).toLowerCase()] || dbChamp;
                }
            }
        });

        card.querySelector('.win-val').value = p.wins || 0;
        card.querySelector('.lose-val').value = p.losses || 0;
    });
}

async function toggleWatch() {
    isWatching = !isWatching;
    const btn = document.getElementById('watchBtn');

    if (isWatching) {
        const nowISO = new Date().toISOString();
        const { data: allPlayers } = await sb.from('players').select('id, recent, champions');
        if (allPlayers && allPlayers.length > 0) {
            const watchUpdates = allPlayers.map(p => ({ id: p.id, watch_since: nowISO }));
            const { error } = await sb.from('players').upsert(watchUpdates, { onConflict: 'id' });
            if (error) log(`watch_since ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            else log(`watch_since ì €ì¥ ì™„ë£Œ (${allPlayers.length}ëª…)`);
        }

        watchSnapshot = {};
        if (allPlayers) {
            allPlayers.forEach(p => {
                watchSnapshot[p.id] = {
                    recent: padArray(p.recent, 10, 'ing'),
                    champions: padArray(p.champions, 10, 'None')
                };
            });
        }
        log(`ê°ì‹œ ì‹œì‘ - ìŠ¤ëƒ…ìƒ· ${Object.keys(watchSnapshot).length}ëª…, watch_since: ${nowISO}`);

        btn.innerText = "â¹ï¸ ê°ì‹œ ì¤‘ (45ì´ˆ ì£¼ê¸°)";
        btn.style.color = "var(--red)"; btn.style.borderColor = "var(--red)";
        btn.style.boxShadow = "var(--neon-red)";

        syncWithRiot();
        watchInterval = setInterval(syncWithRiot, 45000);
    } else {
        log("ê°ì‹œ ì¤‘ì§€");
        btn.innerText = "â–¶ï¸ ìë™ ê°ì‹œ ì‹œì‘";
        btn.style.color = "var(--gold)"; btn.style.borderColor = "var(--gold)";
        btn.style.boxShadow = "var(--neon-gold)";
        clearInterval(watchInterval);
        watchSnapshot = {};
    }
}

function createMemberCard(team, data = null) {
    const card = document.createElement('div');
    card.className = `member-card ${team}`;
    card.dataset.team = team;
    card.dataset.uuid = data?.id || "";

    const safeRecent = padArray(data?.recent, 10, 'ing');
    const safeChamps = padArray(data?.champions, 10, 'None');

    let h = '';
    for (let i = 0; i < 10; i++) {
        const r = safeRecent[i];
        const rt = r === 'win' ? 'ğŸ˜ ìŠ¹ë¦¬' : (r === 'lose' ? 'ğŸ˜¡ íŒ¨ë°°' : 'ğŸ•’ ì§„í–‰');
        const raw = safeChamps[i];
        const cn = (raw && raw !== 'None') ? (idToKorMap[raw] || engToIdMap[raw.toLowerCase()] || raw) : "";
        h += `<div class="history-item"><span>${i+1}íŒ</span><input class="champ-input" placeholder="ì±”í”¼ì–¸" value="${cn}"><button class="btn-toggle ${r}" onclick="toggleResult(this)">${rt}</button></div>`;
    }

    const opts = Object.entries(TIER_MAP).map(([e,k]) => `<option value="${e}">${k}</option>`).join('');
    const isM = data?.manual_tier || false;
    const tierKey = findEngTierKey(data?.tier);
    const lpVal = extractLP(data?.tier);
    log(`ì¹´ë“œìƒì„± [${data?.name||'?'}] DBí‹°ì–´="${data?.tier}" â†’ key="${tierKey}" LP=${lpVal}`);

    card.innerHTML = `<button class="btn-reset-member" onclick="resetMemberRecord(this)" title="ì´ˆê¸°í™”">ğŸ§¹</button>
    <div class="name-row">
        <div class="input-group"><label>ìŠ¤íŠ¸ë¦¬ë¨¸</label><input class="nick-disp" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ëª…" value="${data?.name||''}"></div>
        <div class="input-group" style="flex:2;"><label>ë¡¤ ë‹‰ë„¤ì„</label><input class="nick-riot" placeholder="ë¡¤ ë‹‰ë„¤ì„" value="${data?.riot_id||''}"></div>
        <div class="input-group" style="flex:2.5;">
            <label style="color:var(--gold);"><input type="checkbox" class="tier-override" ${isM?'checked':''} onchange="toggleManual(this)"> ìˆ˜ì •</label>
            <select class="tier-select" ${isM?'':'disabled'} style="opacity:${isM?'1':'0.4'}" onchange="updateTierUI(this)">${opts}</select>
        </div>
        <div class="input-group" style="width:70px;">
            <label style="color:var(--gold);"><input type="checkbox" class="lp-override" ${isM?'checked':''} onchange="toggleManual(this)"> ìˆ˜ì •</label>
            <input class="lp-input" value="${lpVal}" ${isM?'':'disabled'} style="opacity:${isM?'1':'0.4'}">
        </div>
        <div class="input-group"><label style="color:var(--gold);">ìŠ¹</label><input class="score-input win-val" value="${data?.wins??0}"></div>
        <div class="input-group"><label style="color:var(--red);">íŒ¨</label><input class="score-input lose-val" value="${data?.losses??0}"></div>
    </div><div class="history-editor">${h}</div>`;

    setTimeout(() => {
        const s = card.querySelector('.tier-select');
        s.value = tierKey;
        updateTierUI(s);
    }, 0);

    return card;
}

function toggleManual(chk) {
    const card = chk.closest('.member-card');
    const s = card.querySelector('.tier-select'), l = card.querySelector('.lp-input');
    card.querySelectorAll('.tier-override,.lp-override').forEach(c => c.checked = chk.checked);
    s.disabled = l.disabled = !chk.checked;
    s.style.opacity = l.style.opacity = chk.checked ? "1" : "0.4";
}

function toggleResult(b) {
    if (b.innerText.includes('ìŠ¹ë¦¬'))      { b.innerText = 'ğŸ˜¡ íŒ¨ë°°'; b.className = 'btn-toggle lose'; }
    else if (b.innerText.includes('íŒ¨ë°°')) { b.innerText = 'ğŸ•’ ì§„í–‰'; b.className = 'btn-toggle ing'; }
    else                                    { b.innerText = 'ğŸ˜ ìŠ¹ë¦¬'; b.className = 'btn-toggle win'; }
}

function resetMemberRecord(btn) {
    if (!confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
    const card = btn.closest('.member-card');
    card.querySelector('.nick-disp').value = "";
    card.querySelector('.nick-riot').value = "";
    card.querySelector('.win-val').value = 0;
    card.querySelector('.lose-val').value = 0;
    card.querySelectorAll('.btn-toggle').forEach(b => { b.innerText='ğŸ•’ ì§„í–‰'; b.className='btn-toggle ing'; });
    card.querySelectorAll('.champ-input').forEach(i => i.value = "");
}

async function resetAllRecords() {
    if (!confirm("âš ï¸ ì „ì²´ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const { data: current } = await sb.from('players').select('id, team');
    if (!current) return;

    const resetData = current.map(p => ({
        id: p.id, name:"", riot_id:"", tier:"ì–¸ë­í¬",
        wins:0, losses:0,
        recent: Array(10).fill('ing'),
        champions: Array(10).fill('None'),
        manual_tier: false, team: p.team,
        last_sync: '2000-01-01T00:00:00Z',
        trigger_cutscene: false, lp_diff:'',
        event_type: null, target_champion: null,
        last_kda: null, last_match_id: null,
        watch_since: null,
    }));

    const { error } = await sb.from('players').upsert(resetData, { onConflict: 'id' });
    if (error) { alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + error.message); log(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`); }
    else { alert("âœ… ì´ˆê¸°í™” ì™„ë£Œ"); location.reload(); }
}

async function applyToSupabase() {
    const btn = document.querySelector('.btn-apply');
    btn.innerText = "â³ ë°˜ì˜ ì¤‘..."; btn.disabled = true;
    try {
        const updates = [];
        document.querySelectorAll('.member-card').forEach(card => {
            const rawId = card.dataset.uuid;
            const isTemp = !rawId || String(rawId).startsWith('temp-');

            const nameVal = card.querySelector('.nick-disp').value.trim();
            const riotVal = card.querySelector('.nick-riot').value.trim();

            if (isTemp && !nameVal && !riotVal) return;

            const teamBox = card.closest('.team-box');
            const actualTeam = teamBox?.classList.contains('red') ? 'red' : 'blue';

            let rec = [], chs = [];
            card.querySelectorAll('.history-item').forEach(it => {
                const bt = it.querySelector('.btn-toggle').innerText;
                rec.push(bt.includes('ìŠ¹ë¦¬') ? 'win' : bt.includes('íŒ¨ë°°') ? 'lose' : 'ing');
                chs.push(korToIdMap[it.querySelector('.champ-input').value.trim()] || 'None');
            });

            const tC = card.querySelector('.tier-override').checked;
            const tV = card.querySelector('.tier-select').value;
            const lp = card.querySelector('.lp-input').value;
            const ex = cachedPlayers.find(p => String(p.id) === String(rawId));

            const finalId = isTemp
                ? (typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).slice(2)}`)
                : rawId;

            if (isTemp) card.dataset.uuid = finalId;

            updates.push({
                id: finalId,
                name: nameVal,
                team: actualTeam,
                riot_id: riotVal,
                tier: tC ? `${TIER_MAP[tV]} - ${lp}LP` : (ex?.tier || "ì–¸ë­í¬"),
                manual_tier: tC,
                wins: parseInt(card.querySelector('.win-val').value) || 0,
                losses: parseInt(card.querySelector('.lose-val').value) || 0,
                recent: rec,
                champions: chs,
                last_sync: ex?.last_sync ?? null,
                trigger_cutscene: ex?.trigger_cutscene ?? false,
                // âœ… í•µì‹¬ ìˆ˜ì •: last_match_idì™€ watch_since ë³´ì¡´
                last_match_id: ex?.last_match_id ?? null,
                watch_since: ex?.watch_since ?? null,
            });
        });

        await sb.from('settings').upsert({
            id: 1,
            red_team_name: document.getElementById('redNameInput').value,
            blue_team_name: document.getElementById('blueNameInput').value,
            member_count: Number(document.getElementById('teamCount').value)
        });

        if (updates.length > 0) {
            const { error } = await sb.from('players').upsert(updates, { onConflict: 'id' });
            if (error) throw error;
        }
        log(`ì†¡ì¶œ ë°˜ì˜ ì™„ë£Œ (${updates.length}ëª…)`);
        alert('âœ… ë°˜ì˜ ì™„ë£Œ');
        await loadData();
    } catch (e) {
        console.error(e); alert('ì €ì¥ ì˜¤ë¥˜: ' + e.message);
        log(`ì†¡ì¶œ ì˜¤ë¥˜: ${e.message}`);
    } finally {
        btn.innerText = "ì†¡ì¶œ í™”ë©´ ë°˜ì˜"; btn.disabled = false;
    }
}

async function loadData() {
    const { data: s } = await sb.from('settings').select('*').eq('id', 1).maybeSingle();
    if (s) {
        document.getElementById('redNameInput').value = s.red_team_name || "";
        document.getElementById('blueNameInput').value = s.blue_team_name || "";
        document.getElementById('teamCount').value = s.member_count || 5;
        updateTeamNames();
    }
    const { data: p, error } = await sb.from('players').select('*').order('id', { ascending: true });
    if (error) { log(`loadData ì—ëŸ¬: ${error.message}`); return; }
    cachedPlayers = p || [];
    rebuild(p);
    log(`ë°ì´í„° ë¡œë“œ: ${(p||[]).length}ëª…`);
}

function rebuildWithCache() { rebuild(cachedPlayers); }

function rebuild(list) {
    const rW = document.getElementById('redPlayers'), bW = document.getElementById('bluePlayers');
    const cnt = Number(document.getElementById('teamCount').value);
    rW.innerHTML = ''; bW.innerHTML = '';
    const reds = (list||[]).filter(p => p.team === 'red');
    const blues = (list||[]).filter(p => p.team === 'blue');
    for (let i = 0; i < cnt; i++) {
        rW.appendChild(createMemberCard('red',  reds[i]  || { id:`temp-red-${i}`,  team:'red' }));
        bW.appendChild(createMemberCard('blue', blues[i] || { id:`temp-blue-${i}`, team:'blue' }));
    }
}

function updateTeamNames() {
    document.getElementById('redTitle').innerText  = document.getElementById('redNameInput').value  || 'ë ˆë“œ íŒ€';
    document.getElementById('blueTitle').innerText = document.getElementById('blueNameInput').value || 'ë¸”ë£¨ íŒ€';
}

async function start() { await initChampMap(); await loadData(); }
start();
</script>
</body>
</html>
